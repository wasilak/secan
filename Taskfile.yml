version: '3'

tasks:
  dev:
    desc: Build frontend, build backend, and run the server
    cmds:
      - task: build-frontend
      - task: build-backend
      - task: run-backend

  build-frontend:
    desc: Build the frontend React application
    dir: frontend
    cmds:
      - npm run build
    sources:
      - src/**/*
      - index.html
      - package.json
      - vite.config.ts
      - tsconfig.json
    generates:
      - ../assets/**/*

  build-backend:
    desc: Build the Rust backend
    cmds:
      - cargo build
    sources:
      - src/**/*.rs
      - Cargo.toml
      - Cargo.lock
    generates:
      - target/debug/secan

  run-backend:
    desc: Run the backend server
    cmds:
      - cargo run

  clean:
    desc: Clean all build artifacts
    cmds:
      - rm -rf frontend/node_modules
      - rm -rf frontend/dist
      - rm -rf target
      - rm -rf assets

  test:
    desc: Run all tests
    cmds:
      - task: test-backend
      - task: test-frontend

  test-backend:
    desc: Run backend tests
    cmds:
      - cargo test

  test-frontend:
    desc: Run frontend tests
    dir: frontend
    cmds:
      - npm test

  lint:
    desc: Run linters
    cmds:
      - task: lint-backend
      - task: lint-frontend

  lint-backend:
    desc: Run Rust linter
    cmds:
      - cargo clippy
      - cargo fmt --check

  lint-frontend:
    desc: Run TypeScript/React linter
    dir: frontend
    cmds:
      - npm run lint

  bootstrap-data:
    desc: Bootstrap test data in Elasticsearch
    cmds:
      - ./scripts/bootstrap-test-data.sh

  cleanup-data:
    desc: Clean up test data from Elasticsearch
    cmds:
      - ./scripts/cleanup-test-data.sh

  docker-up:
    desc: Start Elasticsearch with Docker Compose
    cmds:
      - docker-compose up -d

  docker-down:
    desc: Stop Elasticsearch
    cmds:
      - docker-compose down

  full-dev:
    desc: Start Elasticsearch, bootstrap data, and run dev server
    cmds:
      - task: docker-up
      - sleep 5
      - task: bootstrap-data
      - task: dev

  fmt:
    desc: Format code
    cmds:
      - cargo fmt --all
      - task: fmt-frontend

  fmt-frontend:
    desc: Format frontend code
    dir: frontend
    cmds:
      - npx prettier --write src/

  build-frontend-release:
    desc: Build frontend for release
    dir: frontend
    cmds:
      - npm ci
      - npm run build

  build-backend-release:
    desc: Build backend for release
    cmds:
      - cargo build --release

  build-backend-target:
    desc: Build backend for specific target
    cmds:
      - cargo build --release --target $TARGET

  install-cross:
    desc: Install cross-compilation tool
    cmds:
      - cargo install cross --git https://github.com/cross-rs/cross

  build-cross-target:
    desc: Build backend using cross for specific target
    cmds:
      - cross build --release --target $TARGET

  package-binary:
    desc: Package binary as tarball (set TARGET and NAME env vars)
    cmds:
      - mkdir -p artifacts
      - cd target/$TARGET/release && tar czf ../../artifacts/secan-$NAME.tar.gz secan && sha256sum secan-$NAME.tar.gz > ../../artifacts/secan-$NAME.tar.gz.sha256

  docker-build-amd64:
    desc: Build Docker image for amd64
    cmds:
      - docker build --platform linux/amd64 -t secan:latest .

  docker-build-multiarch:
    desc: Build Docker image for multiple architectures
    cmds:
      - docker buildx build --platform linux/amd64,linux/arm64 -t secan:latest .

  bump-version:
    desc: Bump version and create git tag. Usage - task bump-version TAG=v0.2.0
    cmds:
      - ./scripts/bump-version.sh {{.TAG}}
