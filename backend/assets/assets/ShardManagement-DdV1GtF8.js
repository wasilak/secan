import{z as De,q as Me,D as ke,r as g,k as Y,o as S,j as e,A as k,I as L,G as d,L as ue,l as K,m as l,M as y,T as b,v as D,w as Le,S as u,F as me,y as pe,N as Re,t as C,ac as qe}from"./index-BWtpBJiN.js";import{u as ee}from"./useMutation-ZfgUOSQB.js";import{u as Pe}from"./useWatermarks-CcnPld-8.js";import{C as Q}from"./Container-rg9Qyubq.js";import{C as p}from"./Card-CcgJzK8Q.js";import{I as Fe,a as _,b as Ge,c as Ue,C as Be}from"./IconMinimize-BB3MWEKt.js";import{I as Oe,a as $e}from"./IconSortDescending-CY2frGdH.js";import{T as Ke}from"./TextInput-C5bPP8gL.js";import{I as Qe}from"./IconFilter-E_DJNgAN.js";import{B as j}from"./Badge-DrGyrtUj.js";import{P as je}from"./Progress-CdM_LJ7f.js";import{u as _e}from"./use-form-qSAolvw4.js";import{B as ge}from"./Button-CwQH4MVC.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./InputsGroupFieldset-BdGKt3Yy.js";function cs(){var oe,de,ce;const{id:t}=De(),h=Me(),[c,z]=ke(),[V,E]=g.useState(!1),[a,w]=g.useState(null),[T,x]=g.useState(!1),[fe,Z]=g.useState(null),[H,se]=g.useState(!1),{getColor:ne}=Pe(t),I=c.get("expanded")==="true",v=c.get("sort")!=="desc",W=c.get("affected")==="true",N=c.get("filter")||"",R=(s,n)=>{const r=new URLSearchParams(c);n===""||n===!1?r.delete(s):r.set(s,String(n)),z(r)},Se=s=>R("expanded",s),ye=s=>R("sort",s?"asc":"desc"),be=s=>R("affected",s),ze=s=>R("filter",s),{data:m,isLoading:we,error:re}=Y({queryKey:["cluster",t,"shards"],queryFn:()=>S.getShards(t),enabled:!!t}),{data:q,isLoading:Ie}=Y({queryKey:["cluster",t,"nodes"],queryFn:()=>S.getNodes(t),enabled:!!t}),{data:P,isLoading:ve}=Y({queryKey:["cluster",t,"settings"],queryFn:async()=>await S.proxyRequest(t,"GET","/_cluster/settings"),enabled:!!t}),Ne=g.useMemo(()=>{var he,xe;if(!P)return!0;const s=P.transient,n=P.persistent,r=s==null?void 0:s.cluster,i=n==null?void 0:n.cluster,f=r==null?void 0:r.routing,o=i==null?void 0:i.routing,Te=(he=f==null?void 0:f.allocation)==null?void 0:he.enable,Ae=(xe=o==null?void 0:o.allocation)==null?void 0:xe.enable;return(Te||Ae||"all")==="all"},[P]),ie=ee({mutationFn:()=>S.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":"all"}}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"settings"]}),C.show({title:"Success",message:"Shard allocation enabled",color:"green"})},onError:s=>{C.show({title:"Error",message:`Failed to enable shard allocation: ${s.message}`,color:"red"})}}),F=ee({mutationFn:s=>S.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":s}}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"settings"]}),C.show({title:"Success",message:"Shard allocation disabled",color:"green"})},onError:s=>{C.show({title:"Error",message:`Failed to disable shard allocation: ${s.message}`,color:"red"})}}),te=ee({mutationFn:({index:s,shard:n,fromNode:r,toNode:i})=>S.proxyRequest(t,"POST","/_cluster/reroute",{commands:[{move:{index:s,shard:n,from_node:r,to_node:i}}]}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"shards"]}),C.show({title:"Success",message:"Shard relocation initiated successfully",color:"green"}),E(!1),w(null)},onError:s=>{C.show({title:"Error",message:`Failed to relocate shard: ${s.message}`,color:"red"})}}),le=s=>{w(s),E(!0)},Ce=s=>{w(s),x(!0)};if(g.useEffect(()=>{T&&a&&!H&&(se(!0),S.getShardStats(t,a.index,a.shard).then(s=>{Z(s)}).catch(s=>{console.error("Failed to fetch shard stats:",s),Z(null)}).finally(()=>{se(!1)}))},[T,a,t,H]),!t)return e.jsx(Q,{size:"xl",children:e.jsx(k,{icon:e.jsx(L,{size:16}),title:"Error",color:"red",children:"Cluster ID is required"})});if(we||Ie||ve)return e.jsx(Q,{size:"xl",children:e.jsx(d,{justify:"center",mt:"xl",children:e.jsx(ue,{size:"lg"})})});if(re)return e.jsx(Q,{size:"xl",children:e.jsxs(k,{icon:e.jsx(L,{size:16}),title:"Error",color:"red",children:["Failed to load shards: ",re.message]})});const G=(m==null?void 0:m.reduce((s,n)=>(s[n.state]||(s[n.state]=[]),s[n.state].push(n),s),{}))||{},U=((oe=G.UNASSIGNED)==null?void 0:oe.length)||0,B=((de=G.RELOCATING)==null?void 0:de.length)||0,O=((ce=G.INITIALIZING)==null?void 0:ce.length)||0,ae=U>0||B>0||O>0,$=(m==null?void 0:m.reduce((s,n)=>(s[n.index]||(s[n.index]=[]),s[n.index].push(n),s),{}))||{},J=g.useMemo(()=>{let s=Object.keys($);return N&&(s=s.filter(n=>n.toLowerCase().includes(N.toLowerCase()))),W&&(s=s.filter(n=>$[n].some(i=>i.state==="UNASSIGNED"||i.state==="RELOCATING"||i.state==="INITIALIZING"))),s.sort((n,r)=>v?n.localeCompare(r):r.localeCompare(n)),s},[$,N,W,v]),X=(m==null?void 0:m.reduce((s,n)=>{const r=n.node||"UNASSIGNED";return s[r]||(s[r]=[]),s[r].push(n),s},{}))||{},A=X.UNASSIGNED||[],Ee=Object.keys(X).filter(s=>s!=="UNASSIGNED");return e.jsxs(Q,{size:"xl",py:"md",children:[e.jsx(d,{justify:"space-between",mb:"md",children:e.jsxs("div",{children:[e.jsx(K,{order:2,children:"Shard Management"}),e.jsx(l,{size:"sm",c:"dimmed",children:"View and manage shard allocation across nodes"})]})}),e.jsx(p,{shadow:"sm",padding:"md",mb:"md",children:e.jsxs(d,{justify:"space-between",children:[e.jsxs(d,{children:[Ne?e.jsxs(y,{shadow:"md",width:200,children:[e.jsx(y.Target,{children:e.jsx(b,{label:"Disable shard allocation",children:e.jsx(D,{size:"lg",variant:"subtle",color:"green",loading:F.isPending,children:e.jsx(Fe,{size:20})})})}),e.jsxs(y.Dropdown,{children:[e.jsx(y.Label,{children:"Disable Allocation"}),e.jsxs(y.Item,{onClick:()=>F.mutate("none"),children:[e.jsx(_,{size:14})," None (default)"]}),e.jsxs(y.Item,{onClick:()=>F.mutate("primaries"),children:[e.jsx(_,{size:14})," Primaries only"]}),e.jsxs(y.Item,{onClick:()=>F.mutate("new_primaries"),children:[e.jsx(_,{size:14})," New primaries only"]})]})]}):e.jsx(b,{label:"Enable shard allocation",children:e.jsx(D,{size:"lg",variant:"subtle",color:"red",onClick:()=>ie.mutate(),loading:ie.isPending,children:e.jsx(_,{size:20})})}),e.jsx(b,{label:I?"Compress view":"Expand view",children:e.jsx(D,{size:"lg",variant:"subtle",onClick:()=>Se(!I),children:I?e.jsx(Ge,{size:20}):e.jsx(Ue,{size:20})})}),e.jsx(b,{label:v?"Sort descending":"Sort ascending",children:e.jsx(D,{size:"lg",variant:"subtle",onClick:()=>ye(!v),children:v?e.jsx(Oe,{size:20}):e.jsx($e,{size:20})})}),e.jsx(b,{label:"Refresh data",children:e.jsx(D,{size:"lg",variant:"subtle",onClick:()=>{h.invalidateQueries({queryKey:["cluster",t,"shards"]}),h.invalidateQueries({queryKey:["cluster",t,"nodes"]}),h.invalidateQueries({queryKey:["cluster",t,"settings"]})},children:e.jsx(Le,{size:20})})})]}),e.jsxs(d,{children:[e.jsx(Ke,{placeholder:"Filter indices...",leftSection:e.jsx(Qe,{size:16}),value:N,onChange:s=>ze(s.currentTarget.value),style:{width:200}}),ae&&e.jsx(Be,{label:"Show only affected",checked:W,onChange:s=>be(s.currentTarget.checked)})]})]})}),ae&&e.jsx(k,{icon:e.jsx(L,{size:16}),title:"Shard Issues Detected",color:"yellow",mb:"md",children:e.jsxs(u,{gap:"xs",children:[U>0&&e.jsxs(l,{size:"sm",children:["âš ï¸ ",U," unassigned shard",U>1?"s":""]}),B>0&&e.jsxs(l,{size:"sm",children:["ðŸ”„ ",B," relocating shard",B>1?"s":""]}),O>0&&e.jsxs(l,{size:"sm",children:["â³ ",O," initializing shard",O>1?"s":""]})]})}),e.jsx(d,{mb:"md",grow:!0,children:Object.entries(G).map(([s,n])=>e.jsx(p,{shadow:"sm",padding:"md",children:e.jsxs(u,{gap:"xs",children:[e.jsx(l,{size:"sm",c:"dimmed",children:s}),e.jsx(l,{size:"xl",fw:700,children:n.length}),e.jsx(j,{size:"sm",color:s==="STARTED"?"green":s==="UNASSIGNED"?"red":"yellow",children:s})]})},s))}),A.length>0&&e.jsxs(p,{shadow:"sm",padding:"lg",mb:"md",style:{backgroundColor:"var(--mantine-color-red-0)"},children:[e.jsxs(d,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx(K,{order:3,children:"Unassigned Shards"}),e.jsxs(l,{size:"sm",c:"dimmed",children:[A.length," shard",A.length>1?"s":""," not allocated to any node"]})]}),e.jsx(j,{size:"lg",color:"red",variant:"filled",children:A.length})]}),e.jsx(u,{gap:"md",children:Object.entries(A.reduce((s,n)=>(s[n.index]||(s[n.index]=[]),s[n.index].push(n),s),{})).filter(([s])=>!(N&&!s.toLowerCase().includes(N.toLowerCase()))).sort(([s],[n])=>v?s.localeCompare(n):n.localeCompare(s)).map(([s,n])=>e.jsx(p,{shadow:"xs",padding:"sm",withBorder:!0,style:{backgroundColor:"white"},children:e.jsxs(u,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),e.jsxs(j,{size:"sm",color:"red",variant:"light",children:[n.length," unassigned"]})]}),e.jsx(d,{gap:"xs",children:n.map((r,i)=>e.jsx(b,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",r.shard]}),e.jsxs("div",{children:["Type: ",r.primary?"Primary":"Replica"]}),e.jsx("div",{children:"State: UNASSIGNED"}),e.jsx("div",{children:"Reason: Not allocated to any node"})]}),children:e.jsx(j,{size:"lg",variant:r.primary?"filled":"light",color:"red",children:r.shard})},`unassigned-${r.index}-${r.shard}-${i}`))})]})},s))})]}),e.jsxs(p,{shadow:"sm",padding:"lg",mb:"md",children:[e.jsx(K,{order:3,mb:"md",children:"Shard Allocation by Node"}),e.jsx(u,{gap:"md",children:Ee.map(s=>{const n=X[s],r=q==null?void 0:q.find(o=>o.name===s),i=n.filter(o=>o.primary).length,f=n.filter(o=>!o.primary).length;return e.jsx(p,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(u,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(l,{size:"sm",fw:500,children:s}),r&&I&&e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"xs",c:"dimmed",children:r.ip}),e.jsxs(l,{size:"xs",c:"dimmed",children:["Roles: ",r.roles.join(", ")]})]})]}),e.jsxs(d,{gap:"xs",children:[e.jsxs(j,{size:"sm",variant:"light",color:"blue",children:[i,"p"]}),e.jsxs(j,{size:"sm",variant:"light",color:"gray",children:[f,"r"]}),e.jsxs(j,{size:"sm",variant:"light",children:[n.length," total"]})]})]}),r&&e.jsxs(d,{gap:"md",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Heap"}),e.jsx(je,{value:Math.round(r.heapUsed/r.heapMax*100),color:ne(Math.round(r.heapUsed/r.heapMax*100)),size:"sm",radius:"xs"}),I&&e.jsxs(l,{size:"xs",c:"dimmed",children:[M(r.heapUsed)," / ",M(r.heapMax)]})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Disk"}),e.jsx(je,{value:Math.round(r.diskUsed/r.diskTotal*100),color:ne(Math.round(r.diskUsed/r.diskTotal*100)),size:"sm",radius:"xs"}),I&&e.jsxs(l,{size:"xs",c:"dimmed",children:[M(r.diskUsed)," / ",M(r.diskTotal)]})]})]})]})},s)})})]}),e.jsxs(p,{shadow:"sm",padding:"lg",children:[e.jsxs(K,{order:3,mb:"md",children:["Shards by Index (",J.length," ",J.length===1?"index":"indices",")"]}),e.jsx(me,{children:e.jsx(u,{gap:"md",children:J.map(s=>{const n=$[s],r=n.some(i=>i.state==="UNASSIGNED"||i.state==="RELOCATING"||i.state==="INITIALIZING");return e.jsx(p,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(u,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),r&&e.jsx(j,{size:"sm",color:"yellow",children:"Has Issues"})]}),e.jsx(d,{gap:"xs",children:n.map((i,f)=>e.jsx(b,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",i.shard]}),e.jsxs("div",{children:["Type: ",i.primary?"Primary":"Replica"]}),e.jsxs("div",{children:["State: ",i.state]}),e.jsxs("div",{children:["Node: ",i.node||"N/A"]}),i.docs!==void 0&&i.docs!==null&&e.jsxs("div",{children:["Docs: ",i.docs.toLocaleString()]}),i.store!==void 0&&i.store!==null&&e.jsxs("div",{children:["Size: ",M(i.store)]})]}),children:e.jsx(j,{size:"lg",variant:i.primary?"filled":"light",color:i.state==="STARTED"?"green":i.state==="UNASSIGNED"?"red":"yellow",style:{cursor:"pointer"},onClick:o=>{o.ctrlKey||o.metaKey||o.button===2?i.state==="STARTED"&&i.node&&(o.preventDefault(),le(i)):Ce(i)},onContextMenu:o=>{i.state==="STARTED"&&i.node&&(o.preventDefault(),le(i))},children:i.shard})},`${i.index}-${i.shard}-${f}`))})]})},s)})})})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx(Ve,{opened:V,onClose:()=>{E(!1),w(null)},shard:a,nodes:q||[],onRelocate:s=>{a.node&&te.mutate({index:a.index,shard:a.shard,fromNode:a.node,toNode:s})},isLoading:te.isPending}),e.jsx(pe,{opened:T,onClose:()=>{x(!1),Z(null)},title:`Shard Details: ${a.index} / ${a.shard}`,size:"lg",children:e.jsx(me,{h:500,children:H?e.jsx(d,{justify:"center",py:"xl",children:e.jsx(ue,{})}):e.jsx(Re,{block:!0,children:JSON.stringify(fe||a,null,2)})})})]})]})}function M(t){if(t===0)return"0 B";const h=1024,c=["B","KB","MB","GB","TB"],z=Math.floor(Math.log(t)/Math.log(h));return`${(t/Math.pow(h,z)).toFixed(2)} ${c[z]}`}function Ve({opened:t,onClose:h,shard:c,nodes:z,onRelocate:V,isLoading:E}){const a=_e({initialValues:{targetNode:""},validate:{targetNode:x=>x?null:"Target node is required"}}),w=z.filter(x=>x.name!==c.node).map(x=>({value:x.name,label:`${x.name} (${x.roles.join(", ")})`})),T=a.onSubmit(x=>{V(x.targetNode)});return e.jsx(pe,{opened:t,onClose:h,title:"Relocate Shard",size:"md",children:e.jsx("form",{onSubmit:T,children:e.jsxs(u,{gap:"md",children:[e.jsx(k,{icon:e.jsx(L,{size:16}),title:"Shard Information",color:"blue",children:e.jsxs(u,{gap:"xs",children:[e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Index:"})," ",c.index]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Shard:"})," ",c.shard]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Type:"})," ",c.primary?"Primary":"Replica"]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Current Node:"})," ",c.node]})]})}),e.jsx(qe,{label:"Target Node",placeholder:"Select target node",data:w,searchable:!0,required:!0,...a.getInputProps("targetNode")}),e.jsx(k,{icon:e.jsx(L,{size:16}),title:"Warning",color:"yellow",children:e.jsx(l,{size:"sm",children:"Relocating shards can impact cluster performance. Ensure the target node has sufficient resources."})}),e.jsxs(d,{justify:"flex-end",mt:"md",children:[e.jsx(ge,{variant:"subtle",onClick:h,children:"Cancel"}),e.jsx(ge,{type:"submit",loading:E,children:"Relocate Shard"})]})]})})})}export{cs as ShardManagement};
