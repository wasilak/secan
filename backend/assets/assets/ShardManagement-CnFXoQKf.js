import{q as be,h as ze,s as Ie,r as O,b as W,j as e,A,I as k,G as a,L as we,T as $,d as l,M as f,k as S,l as T,m as ve,S as h,v as Ne,n as I,f as w,p as Ce,aa as Te}from"./index-B27XFxHg.js";import{u as J}from"./useMutation-Dks7g1Qy.js";import{u as Ee}from"./useWatermarks-aZFw8qtU.js";import{C as K}from"./Container--S7vZyf-.js";import{C as g}from"./Card-DODIW4eT.js";import{I as Ae,a as Q,b as ke,c as Me,C as Re}from"./IconMinimize-XQ8ubPbA.js";import{I as Le,a as qe}from"./IconSortDescending-c1kFvvPB.js";import{T as De}from"./TextInput-CQzUnclL.js";import{I as Pe}from"./IconFilter-B0tmZS0G.js";import{B as j}from"./Badge-BFR-jSfd.js";import{P as oe}from"./Progress-BPMb3b99.js";import{u as Ge}from"./use-form-BHLoNqcl.js";import{B as ae}from"./Button-CtCVQFNb.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./InputsGroupFieldset-g91rxtZN.js";function rs(){var re,ie,ne;const{id:t}=be(),c=ze(),[d,y]=Ie(),[_,v]=O.useState(!1),[x,N]=O.useState(null),{getColor:M}=Ee(t),o=d.get("expanded")==="true",b=d.get("sort")!=="desc",V=d.get("affected")==="true",z=d.get("filter")||"",R=(s,r)=>{const i=new URLSearchParams(d);r===""||r===!1?i.delete(s):i.set(s,String(r)),y(i)},de=s=>R("expanded",s),ce=s=>R("sort",s?"asc":"desc"),he=s=>R("affected",s),xe=s=>R("filter",s),{data:m,isLoading:me,error:X}=W({queryKey:["cluster",t,"shards"],queryFn:()=>w.getShards(t),enabled:!!t}),{data:L,isLoading:ue}=W({queryKey:["cluster",t,"nodes"],queryFn:()=>w.getNodes(t),enabled:!!t}),{data:q,isLoading:je}=W({queryKey:["cluster",t,"settings"],queryFn:async()=>await w.proxyRequest(t,"GET","/_cluster/settings"),enabled:!!t}),ge=O.useMemo(()=>{var te,le;if(!q)return!0;const s=q.transient,r=q.persistent,i=s==null?void 0:s.cluster,n=r==null?void 0:r.cluster,p=i==null?void 0:i.routing,u=n==null?void 0:n.routing,Se=(te=p==null?void 0:p.allocation)==null?void 0:te.enable,ye=(le=u==null?void 0:u.allocation)==null?void 0:le.enable;return(Se||ye||"all")==="all"},[q]),Y=J({mutationFn:()=>w.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":"all"}}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"settings"]}),I.show({title:"Success",message:"Shard allocation enabled",color:"green"})},onError:s=>{I.show({title:"Error",message:`Failed to enable shard allocation: ${s.message}`,color:"red"})}}),D=J({mutationFn:s=>w.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":s}}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"settings"]}),I.show({title:"Success",message:"Shard allocation disabled",color:"green"})},onError:s=>{I.show({title:"Error",message:`Failed to disable shard allocation: ${s.message}`,color:"red"})}}),ee=J({mutationFn:({index:s,shard:r,fromNode:i,toNode:n})=>w.proxyRequest(t,"POST","/_cluster/reroute",{commands:[{move:{index:s,shard:r,from_node:i,to_node:n}}]}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"shards"]}),I.show({title:"Success",message:"Shard relocation initiated successfully",color:"green"}),v(!1),N(null)},onError:s=>{I.show({title:"Error",message:`Failed to relocate shard: ${s.message}`,color:"red"})}}),pe=s=>{N(s),v(!0)};if(!t)return e.jsx(K,{size:"xl",children:e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Error",color:"red",children:"Cluster ID is required"})});if(me||ue||je)return e.jsx(K,{size:"xl",children:e.jsx(a,{justify:"center",mt:"xl",children:e.jsx(we,{size:"lg"})})});if(X)return e.jsx(K,{size:"xl",children:e.jsxs(A,{icon:e.jsx(k,{size:16}),title:"Error",color:"red",children:["Failed to load shards: ",X.message]})});const P=(m==null?void 0:m.reduce((s,r)=>(s[r.state]||(s[r.state]=[]),s[r.state].push(r),s),{}))||{},G=((re=P.UNASSIGNED)==null?void 0:re.length)||0,U=((ie=P.RELOCATING)==null?void 0:ie.length)||0,B=((ne=P.INITIALIZING)==null?void 0:ne.length)||0,se=G>0||U>0||B>0,F=(m==null?void 0:m.reduce((s,r)=>(s[r.index]||(s[r.index]=[]),s[r.index].push(r),s),{}))||{},Z=O.useMemo(()=>{let s=Object.keys(F);return z&&(s=s.filter(r=>r.toLowerCase().includes(z.toLowerCase()))),V&&(s=s.filter(r=>F[r].some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING"))),s.sort((r,i)=>b?r.localeCompare(i):i.localeCompare(r)),s},[F,z,V,b]),H=(m==null?void 0:m.reduce((s,r)=>{const i=r.node||"UNASSIGNED";return s[i]||(s[i]=[]),s[i].push(r),s},{}))||{},C=H.UNASSIGNED||[],fe=Object.keys(H).filter(s=>s!=="UNASSIGNED");return e.jsxs(K,{size:"xl",py:"md",children:[e.jsx(a,{justify:"space-between",mb:"md",children:e.jsxs("div",{children:[e.jsx($,{order:2,children:"Shard Management"}),e.jsx(l,{size:"sm",c:"dimmed",children:"View and manage shard allocation across nodes"})]})}),e.jsx(g,{shadow:"sm",padding:"md",mb:"md",children:e.jsxs(a,{justify:"space-between",children:[e.jsxs(a,{children:[ge?e.jsxs(f,{shadow:"md",width:200,children:[e.jsx(f.Target,{children:e.jsx(S,{label:"Disable shard allocation",children:e.jsx(T,{size:"lg",variant:"subtle",color:"green",loading:D.isPending,children:e.jsx(Ae,{size:20})})})}),e.jsxs(f.Dropdown,{children:[e.jsx(f.Label,{children:"Disable Allocation"}),e.jsxs(f.Item,{onClick:()=>D.mutate("none"),children:[e.jsx(Q,{size:14})," None (default)"]}),e.jsxs(f.Item,{onClick:()=>D.mutate("primaries"),children:[e.jsx(Q,{size:14})," Primaries only"]}),e.jsxs(f.Item,{onClick:()=>D.mutate("new_primaries"),children:[e.jsx(Q,{size:14})," New primaries only"]})]})]}):e.jsx(S,{label:"Enable shard allocation",children:e.jsx(T,{size:"lg",variant:"subtle",color:"red",onClick:()=>Y.mutate(),loading:Y.isPending,children:e.jsx(Q,{size:20})})}),e.jsx(S,{label:o?"Compress view":"Expand view",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>de(!o),children:o?e.jsx(ke,{size:20}):e.jsx(Me,{size:20})})}),e.jsx(S,{label:b?"Sort descending":"Sort ascending",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>ce(!b),children:b?e.jsx(Le,{size:20}):e.jsx(qe,{size:20})})}),e.jsx(S,{label:"Refresh data",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>{c.invalidateQueries({queryKey:["cluster",t,"shards"]}),c.invalidateQueries({queryKey:["cluster",t,"nodes"]}),c.invalidateQueries({queryKey:["cluster",t,"settings"]})},children:e.jsx(ve,{size:20})})})]}),e.jsxs(a,{children:[e.jsx(De,{placeholder:"Filter indices...",leftSection:e.jsx(Pe,{size:16}),value:z,onChange:s=>xe(s.currentTarget.value),style:{width:200}}),se&&e.jsx(Re,{label:"Show only affected",checked:V,onChange:s=>he(s.currentTarget.checked)})]})]})}),se&&e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Shard Issues Detected",color:"yellow",mb:"md",children:e.jsxs(h,{gap:"xs",children:[G>0&&e.jsxs(l,{size:"sm",children:["âš ï¸ ",G," unassigned shard",G>1?"s":""]}),U>0&&e.jsxs(l,{size:"sm",children:["ðŸ”„ ",U," relocating shard",U>1?"s":""]}),B>0&&e.jsxs(l,{size:"sm",children:["â³ ",B," initializing shard",B>1?"s":""]})]})}),e.jsx(a,{mb:"md",grow:!0,children:Object.entries(P).map(([s,r])=>e.jsx(g,{shadow:"sm",padding:"md",children:e.jsxs(h,{gap:"xs",children:[e.jsx(l,{size:"sm",c:"dimmed",children:s}),e.jsx(l,{size:"xl",fw:700,children:r.length}),e.jsx(j,{size:"sm",color:s==="STARTED"?"green":s==="UNASSIGNED"?"red":"yellow",children:s})]})},s))}),C.length>0&&e.jsxs(g,{shadow:"sm",padding:"lg",mb:"md",style:{backgroundColor:"var(--mantine-color-red-0)"},children:[e.jsxs(a,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx($,{order:3,children:"Unassigned Shards"}),e.jsxs(l,{size:"sm",c:"dimmed",children:[C.length," shard",C.length>1?"s":""," not allocated to any node"]})]}),e.jsx(j,{size:"lg",color:"red",variant:"filled",children:C.length})]}),e.jsx(h,{gap:"md",children:Object.entries(C.reduce((s,r)=>(s[r.index]||(s[r.index]=[]),s[r.index].push(r),s),{})).filter(([s])=>!(z&&!s.toLowerCase().includes(z.toLowerCase()))).sort(([s],[r])=>b?s.localeCompare(r):r.localeCompare(s)).map(([s,r])=>e.jsx(g,{shadow:"xs",padding:"sm",withBorder:!0,style:{backgroundColor:"white"},children:e.jsxs(h,{gap:"xs",children:[e.jsxs(a,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),e.jsxs(j,{size:"sm",color:"red",variant:"light",children:[r.length," unassigned"]})]}),e.jsx(a,{gap:"xs",children:r.map((i,n)=>e.jsx(S,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",i.shard]}),e.jsxs("div",{children:["Type: ",i.primary?"Primary":"Replica"]}),e.jsx("div",{children:"State: UNASSIGNED"}),e.jsx("div",{children:"Reason: Not allocated to any node"})]}),children:e.jsx(j,{size:"lg",variant:i.primary?"filled":"light",color:"red",children:i.shard})},`unassigned-${i.index}-${i.shard}-${n}`))})]})},s))})]}),e.jsxs(g,{shadow:"sm",padding:"lg",mb:"md",children:[e.jsx($,{order:3,mb:"md",children:"Shard Allocation by Node"}),e.jsx(h,{gap:"md",children:fe.map(s=>{const r=H[s],i=L==null?void 0:L.find(u=>u.name===s),n=r.filter(u=>u.primary).length,p=r.filter(u=>!u.primary).length;return e.jsx(g,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(h,{gap:"xs",children:[e.jsxs(a,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(l,{size:"sm",fw:500,children:s}),i&&o&&e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"xs",c:"dimmed",children:i.ip}),e.jsxs(l,{size:"xs",c:"dimmed",children:["Roles: ",i.roles.join(", ")]})]})]}),e.jsxs(a,{gap:"xs",children:[e.jsxs(j,{size:"sm",variant:"light",color:"blue",children:[n,"p"]}),e.jsxs(j,{size:"sm",variant:"light",color:"gray",children:[p,"r"]}),e.jsxs(j,{size:"sm",variant:"light",children:[r.length," total"]})]})]}),i&&e.jsxs(a,{gap:"md",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Heap"}),e.jsx(oe,{value:Math.round(i.heapUsed/i.heapMax*100),color:M(Math.round(i.heapUsed/i.heapMax*100)),size:"sm",radius:"xs"}),o&&e.jsxs(l,{size:"xs",c:"dimmed",children:[E(i.heapUsed)," / ",E(i.heapMax)]})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Disk"}),e.jsx(oe,{value:Math.round(i.diskUsed/i.diskTotal*100),color:M(Math.round(i.diskUsed/i.diskTotal*100)),size:"sm",radius:"xs"}),o&&e.jsxs(l,{size:"xs",c:"dimmed",children:[E(i.diskUsed)," / ",E(i.diskTotal)]})]})]})]})},s)})})]}),e.jsxs(g,{shadow:"sm",padding:"lg",children:[e.jsxs($,{order:3,mb:"md",children:["Shards by Index (",Z.length," ",Z.length===1?"index":"indices",")"]}),e.jsx(Ne,{children:e.jsx(h,{gap:"md",children:Z.map(s=>{const r=F[s],i=r.some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING");return e.jsx(g,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(h,{gap:"xs",children:[e.jsxs(a,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),i&&e.jsx(j,{size:"sm",color:"yellow",children:"Has Issues"})]}),e.jsx(a,{gap:"xs",children:r.map((n,p)=>e.jsx(S,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",n.shard]}),e.jsxs("div",{children:["Type: ",n.primary?"Primary":"Replica"]}),e.jsxs("div",{children:["State: ",n.state]}),e.jsxs("div",{children:["Node: ",n.node||"N/A"]}),n.docs!==void 0&&n.docs!==null&&e.jsxs("div",{children:["Docs: ",n.docs.toLocaleString()]}),n.store!==void 0&&n.store!==null&&e.jsxs("div",{children:["Size: ",E(n.store)]})]}),children:e.jsx(j,{size:"lg",variant:n.primary?"filled":"light",color:n.state==="STARTED"?"green":n.state==="UNASSIGNED"?"red":"yellow",style:{cursor:n.state==="STARTED"&&n.node?"pointer":"default"},onClick:()=>{n.state==="STARTED"&&n.node&&pe(n)},children:n.shard})},`${n.index}-${n.shard}-${p}`))})]})},s)})})})]}),x&&e.jsx(Ue,{opened:_,onClose:()=>{v(!1),N(null)},shard:x,nodes:L||[],onRelocate:s=>{x.node&&ee.mutate({index:x.index,shard:x.shard,fromNode:x.node,toNode:s})},isLoading:ee.isPending})]})}function E(t){if(t===0)return"0 B";const c=1024,d=["B","KB","MB","GB","TB"],y=Math.floor(Math.log(t)/Math.log(c));return`${(t/Math.pow(c,y)).toFixed(2)} ${d[y]}`}function Ue({opened:t,onClose:c,shard:d,nodes:y,onRelocate:_,isLoading:v}){const x=Ge({initialValues:{targetNode:""},validate:{targetNode:o=>o?null:"Target node is required"}}),N=y.filter(o=>o.name!==d.node).map(o=>({value:o.name,label:`${o.name} (${o.roles.join(", ")})`})),M=x.onSubmit(o=>{_(o.targetNode)});return e.jsx(Ce,{opened:t,onClose:c,title:"Relocate Shard",size:"md",children:e.jsx("form",{onSubmit:M,children:e.jsxs(h,{gap:"md",children:[e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Shard Information",color:"blue",children:e.jsxs(h,{gap:"xs",children:[e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Index:"})," ",d.index]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Shard:"})," ",d.shard]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Type:"})," ",d.primary?"Primary":"Replica"]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Current Node:"})," ",d.node]})]})}),e.jsx(Te,{label:"Target Node",placeholder:"Select target node",data:N,searchable:!0,required:!0,...x.getInputProps("targetNode")}),e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Warning",color:"yellow",children:e.jsx(l,{size:"sm",children:"Relocating shards can impact cluster performance. Ensure the target node has sufficient resources."})}),e.jsxs(a,{justify:"flex-end",mt:"md",children:[e.jsx(ae,{variant:"subtle",onClick:c,children:"Cancel"}),e.jsx(ae,{type:"submit",loading:v,children:"Relocate Shard"})]})]})})})}export{rs as ShardManagement};
