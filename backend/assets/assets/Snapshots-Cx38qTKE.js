import{e as q,V as _,K as T,r as v,k as E,j as e,A as I,I as z,G as j,$ as K,ar as B,l as Q,m as o,a8 as $,S as k,a0 as W,n,a6 as V,N as X,L as S,o as b,R as G}from"./index-DPI-VPBX.js";import{u as A}from"./useMutation-DQhe41oY.js";import{C as R}from"./Container-BC5qonJY.js";import{B as d}from"./Button-Biw0P4mg.js";import{I as H}from"./IconArrowLeft-DU0lpV77.js";import{C as J}from"./Card-BHPOlYfL.js";import{B as Y}from"./Badge-BxjT7zZW.js";import{I as Z}from"./IconTrash-DgPjtoh8.js";import{I as ee}from"./IconClock-CidYFJs1.js";import{I as se}from"./IconCheck-69wbMcL8.js";import{u as F}from"./use-form-DCV6srxF.js";import{T as P}from"./TextInput-DPIh92VY.js";import{M as L}from"./MultiSelect-Dz7WryBK.js";import{S as p}from"./Switch-DzHpZmOg.js";import"./InputsGroupFieldset-B17iU0gu.js";var te=q("restore","IconRestore",[["path",{d:"M3.06 13a9 9 0 1 0 .49 -4.087",key:"svg-0"}],["path",{d:"M3 4.001v5h5",key:"svg-1"}],["path",{d:"M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-2"}]]),re=q("x","IconX",[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]]);function Ie(){const{id:i,repository:a}=_(),h=T(),[m,l]=v.useState(!1),[g,t]=v.useState(!1),[c,x]=v.useState(null),{data:r,isLoading:N,error:w}=E({queryKey:["cluster",i,"snapshots",a],queryFn:()=>b.getSnapshots(i,a),enabled:!!i&&!!a,refetchInterval:s=>{const u=s.state.data;return(u==null?void 0:u.some(y=>y.state==="IN_PROGRESS"))?5e3:!1}}),{data:C}=E({queryKey:["cluster",i,"indices"],queryFn:()=>b.getIndices(i),enabled:!!i}),M=A({mutationFn:s=>b.deleteSnapshot(i,a,s),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",i,"snapshots",a]}),S.show({title:"Success",message:"Snapshot deleted successfully",color:"green"})},onError:s=>{S.show({title:"Error",message:`Failed to delete snapshot: ${s.message}`,color:"red"})}});if(!i||!a)return e.jsx(R,{size:"xl",children:e.jsx(I,{icon:e.jsx(z,{size:16}),title:"Error",color:"red",children:"Cluster ID and repository name are required"})});if(N)return e.jsx(R,{size:"xl",children:e.jsx(j,{justify:"center",mt:"xl",children:e.jsx(K,{size:"lg"})})});if(w)return e.jsx(R,{size:"xl",children:e.jsxs(I,{icon:e.jsx(z,{size:16}),title:"Error",color:"red",children:["Failed to load snapshots: ",w.message]})});const O=s=>{switch(s){case"SUCCESS":return"green";case"IN_PROGRESS":return"blue";case"FAILED":return"red";case"PARTIAL":return"yellow";default:return"gray"}},U=s=>{switch(s){case"SUCCESS":return e.jsx(se,{size:16});case"IN_PROGRESS":return e.jsx(ee,{size:16});case"FAILED":return e.jsx(re,{size:16});case"PARTIAL":return e.jsx(z,{size:16});default:return null}},D=s=>{if(!s)return"N/A";const u=Math.floor(s/1e3),f=Math.floor(u/60),y=Math.floor(f/60);return y>0?`${y}h ${f%60}m`:f>0?`${f}m ${u%60}s`:`${u}s`};return e.jsxs(R,{size:"xl",py:"md",children:[e.jsxs(j,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx(j,{gap:"xs",mb:"xs",children:e.jsx(d,{component:B,to:`/cluster/${i}/repositories`,variant:"subtle",size:"xs",leftSection:e.jsx(H,{size:16}),children:"Back to Repositories"})}),e.jsxs(Q,{order:2,children:["Snapshots in ",a]}),e.jsx(o,{size:"sm",c:"dimmed",children:"Manage snapshots for backup and restore operations"})]}),e.jsx(d,{leftSection:e.jsx($,{size:16}),onClick:()=>l(!0),children:"Create Snapshot"})]}),e.jsx(J,{shadow:"sm",padding:"lg",children:!r||r.length===0?e.jsxs(k,{gap:"md",align:"center",py:"xl",children:[e.jsx(o,{c:"dimmed",children:"No snapshots found in this repository"}),e.jsx(d,{leftSection:e.jsx($,{size:16}),onClick:()=>l(!0),children:"Create Snapshot"})]}):e.jsx(W,{children:e.jsxs(n,{striped:!0,highlightOnHover:!0,children:[e.jsx(n.Thead,{children:e.jsxs(n.Tr,{children:[e.jsx(n.Th,{children:"Snapshot"}),e.jsx(n.Th,{children:"State"}),e.jsx(n.Th,{children:"Indices"}),e.jsx(n.Th,{children:"Shards"}),e.jsx(n.Th,{children:"Start Time"}),e.jsx(n.Th,{children:"Duration"}),e.jsx(n.Th,{children:"Actions"})]})}),e.jsx(n.Tbody,{children:r.map(s=>e.jsxs(n.Tr,{children:[e.jsxs(n.Td,{children:[e.jsx(o,{size:"sm",fw:500,children:s.snapshot}),e.jsx(o,{size:"xs",c:"dimmed",children:s.uuid})]}),e.jsxs(n.Td,{children:[e.jsx(Y,{size:"sm",variant:"light",color:O(s.state),leftSection:U(s.state),children:s.state}),s.state==="IN_PROGRESS"&&s.shards&&e.jsx(V,{value:s.shards.successful/s.shards.total*100,size:"sm",radius:"xs",mt:"xs"})]}),e.jsx(n.Td,{children:e.jsxs(o,{size:"sm",children:[s.indices.length," indices"]})}),e.jsx(n.Td,{children:s.shards?e.jsxs(o,{size:"sm",children:[s.shards.successful,"/",s.shards.total,s.shards.failed>0&&e.jsxs(o,{component:"span",c:"red",children:[" (",s.shards.failed," failed)"]})]}):e.jsx(o,{size:"sm",c:"dimmed",children:"N/A"})}),e.jsx(n.Td,{children:e.jsx(o,{size:"sm",children:new Date(s.startTime).toLocaleString()})}),e.jsx(n.Td,{children:e.jsx(o,{size:"sm",children:D(s.durationInMillis)})}),e.jsx(n.Td,{children:e.jsxs(j,{gap:"xs",children:[e.jsx(d,{size:"xs",variant:"light",leftSection:e.jsx(te,{size:14}),onClick:()=>{x(s),t(!0)},disabled:s.state!=="SUCCESS"&&s.state!=="PARTIAL",children:"Restore"}),e.jsx(X,{color:"red",variant:"subtle",onClick:()=>{confirm(`Delete snapshot "${s.snapshot}"?`)&&M.mutate(s.snapshot)},loading:M.isPending,disabled:s.state==="IN_PROGRESS",children:e.jsx(Z,{size:16})})]})})]},s.snapshot))})]})})}),e.jsx(ne,{opened:m,onClose:()=>l(!1),clusterId:i,repository:a,availableIndices:(C==null?void 0:C.map(s=>s.name))||[]}),c&&e.jsx(ae,{opened:g,onClose:()=>{t(!1),x(null)},clusterId:i,repository:a,snapshot:c})]})}function ne({opened:i,onClose:a,clusterId:h,repository:m,availableIndices:l}){const g=T(),t=F({initialValues:{snapshot:"",indices:[],ignoreUnavailable:!1,includeGlobalState:!0,partial:!1},validate:{snapshot:r=>r?r.startsWith("_")||r.startsWith("-")||r.startsWith("+")?"Snapshot name cannot start with _, -, or +":null:"Snapshot name is required"}}),c=A({mutationFn:r=>b.createSnapshot(h,m,r),onSuccess:()=>{g.invalidateQueries({queryKey:["cluster",h,"snapshots",m]}),S.show({title:"Success",message:"Snapshot creation started",color:"green"}),t.reset(),a()},onError:r=>{S.show({title:"Error",message:`Failed to create snapshot: ${r.message}`,color:"red"})}}),x=t.onSubmit(r=>{c.mutate(r)});return e.jsx(G,{opened:i,onClose:a,title:"Create Snapshot",size:"lg",children:e.jsx("form",{onSubmit:x,children:e.jsxs(k,{gap:"md",children:[e.jsx(P,{label:"Snapshot Name",placeholder:"snapshot-2024-01-01",required:!0,...t.getInputProps("snapshot")}),e.jsx(L,{label:"Indices",description:"Select specific indices to snapshot (leave empty for all indices)",placeholder:"Select indices",data:l,searchable:!0,clearable:!0,...t.getInputProps("indices")}),e.jsx(p,{label:"Ignore Unavailable Indices",description:"Continue snapshot even if some indices are unavailable",...t.getInputProps("ignoreUnavailable",{type:"checkbox"})}),e.jsx(p,{label:"Include Global State",description:"Include cluster global state in the snapshot",...t.getInputProps("includeGlobalState",{type:"checkbox"})}),e.jsx(p,{label:"Allow Partial Snapshot",description:"Allow snapshot to succeed even if some shards fail",...t.getInputProps("partial",{type:"checkbox"})}),e.jsx(I,{color:"blue",title:"Snapshot Information",children:e.jsx(o,{size:"sm",children:"Snapshots are incremental and only store data that has changed since the last snapshot. The snapshot process runs in the background and does not block indexing or search operations."})}),e.jsxs(j,{justify:"flex-end",mt:"md",children:[e.jsx(d,{variant:"subtle",onClick:a,children:"Cancel"}),e.jsx(d,{type:"submit",loading:c.isPending,children:"Create Snapshot"})]})]})})})}function ae({opened:i,onClose:a,clusterId:h,repository:m,snapshot:l}){const g=T(),t=F({initialValues:{indices:[],ignoreUnavailable:!1,includeGlobalState:!1,renamePattern:"",renameReplacement:"",includeAliases:!0,partial:!1}}),c=A({mutationFn:r=>b.restoreSnapshot(h,m,l.snapshot,r),onSuccess:()=>{g.invalidateQueries({queryKey:["cluster",h,"indices"]}),S.show({title:"Success",message:"Snapshot restore started",color:"green"}),t.reset(),a()},onError:r=>{S.show({title:"Error",message:`Failed to restore snapshot: ${r.message}`,color:"red"})}}),x=t.onSubmit(r=>{c.mutate(r)});return e.jsx(G,{opened:i,onClose:a,title:`Restore Snapshot: ${l.snapshot}`,size:"lg",children:e.jsx("form",{onSubmit:x,children:e.jsxs(k,{gap:"md",children:[e.jsx(I,{color:"blue",title:"Snapshot Contents",children:e.jsxs(o,{size:"sm",children:["This snapshot contains ",l.indices.length," indices: ",l.indices.join(", ")]})}),e.jsx(L,{label:"Indices to Restore",description:"Select specific indices to restore (leave empty to restore all)",placeholder:"Select indices",data:l.indices,searchable:!0,clearable:!0,...t.getInputProps("indices")}),e.jsx(P,{label:"Rename Pattern (Regex)",placeholder:"(.+)",description:"Regular expression pattern to match index names",...t.getInputProps("renamePattern")}),e.jsx(P,{label:"Rename Replacement",placeholder:"restored-$1",description:"Replacement pattern for renamed indices (use $1, $2 for capture groups)",...t.getInputProps("renameReplacement")}),e.jsx(p,{label:"Ignore Unavailable Indices",description:"Continue restore even if some indices are unavailable",...t.getInputProps("ignoreUnavailable",{type:"checkbox"})}),e.jsx(p,{label:"Include Global State",description:"Restore cluster global state from the snapshot",...t.getInputProps("includeGlobalState",{type:"checkbox"})}),e.jsx(p,{label:"Include Aliases",description:"Restore index aliases from the snapshot",...t.getInputProps("includeAliases",{type:"checkbox"})}),e.jsx(p,{label:"Allow Partial Restore",description:"Allow restore to succeed even if some shards fail",...t.getInputProps("partial",{type:"checkbox"})}),e.jsx(I,{color:"yellow",title:"Warning",children:e.jsx(o,{size:"sm",children:"Restoring a snapshot will close and reopen the target indices. Ensure you understand the implications before proceeding. Use rename pattern to avoid conflicts with existing indices."})}),e.jsxs(j,{justify:"flex-end",mt:"md",children:[e.jsx(d,{variant:"subtle",onClick:a,children:"Cancel"}),e.jsx(d,{type:"submit",loading:c.isPending,color:"orange",children:"Restore Snapshot"})]})]})})})}export{Ie as Snapshots};
