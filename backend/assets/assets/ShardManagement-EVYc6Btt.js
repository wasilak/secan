import{z as Ae,q as Me,D as ke,r as p,k as ee,o as y,j as e,A as L,I as P,G as d,L as Re,l as _,m as a,M as b,T as z,v as k,w as Le,S as m,F as ue,y as je,N as Pe,t as T,ab as qe}from"./index-BjLyXSH1.js";import{u as se}from"./useMutation-CYSyA9aA.js";import{u as Fe}from"./useWatermarks-CBWccONX.js";import{C as V}from"./Container-L7bw2dDo.js";import{C as f}from"./Card-CZDf-5xu.js";import{I as Ge,a as Z,b as Ue,c as Be,C as Oe}from"./IconMinimize-kPc81Ou4.js";import{I as $e,a as Ke}from"./IconSortDescending-DXNU7eV4.js";import{T as Qe}from"./TextInput-AfnIcg50.js";import{I as _e}from"./IconFilter-DukjYHWx.js";import{B as u}from"./Badge-DnvKuW5w.js";import{P as me}from"./Progress-9TG4ZgoQ.js";import{S as g}from"./Skeleton-C_ooSiCu.js";import{u as Ve}from"./use-form-c97Aa8y1.js";import{B as ge}from"./Button-BkCnhTlu.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./InputsGroupFieldset-B4cbASYd.js";function xs(){var oe,de,ce;const{id:t}=Ae(),h=Me(),[c,w]=ke(),[H,D]=p.useState(!1),[l,I]=p.useState(null),[v,x]=p.useState(!1),[pe,A]=p.useState(null),[fe,W]=p.useState(!1),{getColor:ie}=Fe(t),N=c.get("expanded")==="true",C=c.get("sort")!=="desc",J=c.get("affected")==="true",E=c.get("filter")||"",q=(s,i)=>{const r=new URLSearchParams(c);i===""||i===!1?r.delete(s):r.set(s,String(i)),w(r)},Se=s=>q("expanded",s),ye=s=>q("sort",s?"asc":"desc"),be=s=>q("affected",s),ze=s=>q("filter",s),{data:j,isLoading:we,error:re}=ee({queryKey:["cluster",t,"shards"],queryFn:()=>y.getShards(t),enabled:!!t}),{data:F,isLoading:Ie}=ee({queryKey:["cluster",t,"nodes"],queryFn:()=>y.getNodes(t),enabled:!!t}),{data:G,isLoading:ve}=ee({queryKey:["cluster",t,"settings"],queryFn:async()=>await y.proxyRequest(t,"GET","/_cluster/settings"),enabled:!!t}),Ne=p.useMemo(()=>{var he,xe;if(!G)return!0;const s=G.transient,i=G.persistent,r=s==null?void 0:s.cluster,n=i==null?void 0:i.cluster,S=r==null?void 0:r.routing,o=n==null?void 0:n.routing,Te=(he=S==null?void 0:S.allocation)==null?void 0:he.enable,De=(xe=o==null?void 0:o.allocation)==null?void 0:xe.enable;return(Te||De||"all")==="all"},[G]),ne=se({mutationFn:()=>y.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":"all"}}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"settings"]}),T.show({title:"Success",message:"Shard allocation enabled",color:"green"})},onError:s=>{T.show({title:"Error",message:`Failed to enable shard allocation: ${s.message}`,color:"red"})}}),U=se({mutationFn:s=>y.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":s}}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"settings"]}),T.show({title:"Success",message:"Shard allocation disabled",color:"green"})},onError:s=>{T.show({title:"Error",message:`Failed to disable shard allocation: ${s.message}`,color:"red"})}}),te=se({mutationFn:({index:s,shard:i,fromNode:r,toNode:n})=>y.proxyRequest(t,"POST","/_cluster/reroute",{commands:[{move:{index:s,shard:i,from_node:r,to_node:n}}]}),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",t,"shards"]}),T.show({title:"Success",message:"Shard relocation initiated successfully",color:"green"}),D(!1),I(null)},onError:s=>{T.show({title:"Error",message:`Failed to relocate shard: ${s.message}`,color:"red"})}}),le=s=>{I(s),D(!0)},Ce=s=>{I(s),x(!0)};if(p.useEffect(()=>{v&&l?(W(!0),A(null),console.log("Fetching shard stats:",{clusterId:t,index:l.index,shard:l.shard}),y.getShardStats(t,l.index,l.shard).then(s=>{console.log("Received shard stats:",s),A(s)}).catch(s=>{console.error("Failed to fetch shard stats:",s),A(l)}).finally(()=>{W(!1)})):v||(A(null),W(!1))},[v,l==null?void 0:l.index,l==null?void 0:l.shard,t]),!t)return e.jsx(V,{size:"xl",children:e.jsx(L,{icon:e.jsx(P,{size:16}),title:"Error",color:"red",children:"Cluster ID is required"})});if(we||Ie||ve)return e.jsx(V,{size:"xl",children:e.jsx(d,{justify:"center",mt:"xl",children:e.jsx(Re,{size:"lg"})})});if(re)return e.jsx(V,{size:"xl",children:e.jsxs(L,{icon:e.jsx(P,{size:16}),title:"Error",color:"red",children:["Failed to load shards: ",re.message]})});const B=(j==null?void 0:j.reduce((s,i)=>(s[i.state]||(s[i.state]=[]),s[i.state].push(i),s),{}))||{},O=((oe=B.UNASSIGNED)==null?void 0:oe.length)||0,$=((de=B.RELOCATING)==null?void 0:de.length)||0,K=((ce=B.INITIALIZING)==null?void 0:ce.length)||0,ae=O>0||$>0||K>0,Q=(j==null?void 0:j.reduce((s,i)=>(s[i.index]||(s[i.index]=[]),s[i.index].push(i),s),{}))||{},X=p.useMemo(()=>{let s=Object.keys(Q);return E&&(s=s.filter(i=>i.toLowerCase().includes(E.toLowerCase()))),J&&(s=s.filter(i=>Q[i].some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING"))),s.sort((i,r)=>C?i.localeCompare(r):r.localeCompare(i)),s},[Q,E,J,C]),Y=(j==null?void 0:j.reduce((s,i)=>{const r=i.node||"UNASSIGNED";return s[r]||(s[r]=[]),s[r].push(i),s},{}))||{},M=Y.UNASSIGNED||[],Ee=Object.keys(Y).filter(s=>s!=="UNASSIGNED");return e.jsxs(V,{size:"xl",py:"md",children:[e.jsx(d,{justify:"space-between",mb:"md",children:e.jsxs("div",{children:[e.jsx(_,{order:2,children:"Shard Management"}),e.jsx(a,{size:"sm",c:"dimmed",children:"View and manage shard allocation across nodes"})]})}),e.jsx(f,{shadow:"sm",padding:"md",mb:"md",children:e.jsxs(d,{justify:"space-between",children:[e.jsxs(d,{children:[Ne?e.jsxs(b,{shadow:"md",width:200,children:[e.jsx(b.Target,{children:e.jsx(z,{label:"Disable shard allocation",children:e.jsx(k,{size:"lg",variant:"subtle",color:"green",loading:U.isPending,children:e.jsx(Ge,{size:20})})})}),e.jsxs(b.Dropdown,{children:[e.jsx(b.Label,{children:"Disable Allocation"}),e.jsxs(b.Item,{onClick:()=>U.mutate("none"),children:[e.jsx(Z,{size:14})," None (default)"]}),e.jsxs(b.Item,{onClick:()=>U.mutate("primaries"),children:[e.jsx(Z,{size:14})," Primaries only"]}),e.jsxs(b.Item,{onClick:()=>U.mutate("new_primaries"),children:[e.jsx(Z,{size:14})," New primaries only"]})]})]}):e.jsx(z,{label:"Enable shard allocation",children:e.jsx(k,{size:"lg",variant:"subtle",color:"red",onClick:()=>ne.mutate(),loading:ne.isPending,children:e.jsx(Z,{size:20})})}),e.jsx(z,{label:N?"Compress view":"Expand view",children:e.jsx(k,{size:"lg",variant:"subtle",onClick:()=>Se(!N),children:N?e.jsx(Ue,{size:20}):e.jsx(Be,{size:20})})}),e.jsx(z,{label:C?"Sort descending":"Sort ascending",children:e.jsx(k,{size:"lg",variant:"subtle",onClick:()=>ye(!C),children:C?e.jsx($e,{size:20}):e.jsx(Ke,{size:20})})}),e.jsx(z,{label:"Refresh data",children:e.jsx(k,{size:"lg",variant:"subtle",onClick:()=>{h.invalidateQueries({queryKey:["cluster",t,"shards"]}),h.invalidateQueries({queryKey:["cluster",t,"nodes"]}),h.invalidateQueries({queryKey:["cluster",t,"settings"]})},children:e.jsx(Le,{size:20})})})]}),e.jsxs(d,{children:[e.jsx(Qe,{placeholder:"Filter indices...",leftSection:e.jsx(_e,{size:16}),value:E,onChange:s=>ze(s.currentTarget.value),style:{width:200}}),ae&&e.jsx(Oe,{label:"Show only affected",checked:J,onChange:s=>be(s.currentTarget.checked)})]})]})}),ae&&e.jsx(L,{icon:e.jsx(P,{size:16}),title:"Shard Issues Detected",color:"yellow",mb:"md",children:e.jsxs(m,{gap:"xs",children:[O>0&&e.jsxs(a,{size:"sm",children:["âš ï¸ ",O," unassigned shard",O>1?"s":""]}),$>0&&e.jsxs(a,{size:"sm",children:["ðŸ”„ ",$," relocating shard",$>1?"s":""]}),K>0&&e.jsxs(a,{size:"sm",children:["â³ ",K," initializing shard",K>1?"s":""]})]})}),e.jsx(d,{mb:"md",grow:!0,children:Object.entries(B).map(([s,i])=>e.jsx(f,{shadow:"sm",padding:"md",children:e.jsxs(m,{gap:"xs",children:[e.jsx(a,{size:"sm",c:"dimmed",children:s}),e.jsx(a,{size:"xl",fw:700,children:i.length}),e.jsx(u,{size:"sm",color:s==="STARTED"?"green":s==="UNASSIGNED"?"red":"yellow",children:s})]})},s))}),M.length>0&&e.jsxs(f,{shadow:"sm",padding:"lg",mb:"md",style:{backgroundColor:"var(--mantine-color-red-0)"},children:[e.jsxs(d,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx(_,{order:3,children:"Unassigned Shards"}),e.jsxs(a,{size:"sm",c:"dimmed",children:[M.length," shard",M.length>1?"s":""," not allocated to any node"]})]}),e.jsx(u,{size:"lg",color:"red",variant:"filled",children:M.length})]}),e.jsx(m,{gap:"md",children:Object.entries(M.reduce((s,i)=>(s[i.index]||(s[i.index]=[]),s[i.index].push(i),s),{})).filter(([s])=>!(E&&!s.toLowerCase().includes(E.toLowerCase()))).sort(([s],[i])=>C?s.localeCompare(i):i.localeCompare(s)).map(([s,i])=>e.jsx(f,{shadow:"xs",padding:"sm",withBorder:!0,style:{backgroundColor:"white"},children:e.jsxs(m,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsx(a,{size:"sm",fw:500,children:s}),e.jsxs(u,{size:"sm",color:"red",variant:"light",children:[i.length," unassigned"]})]}),e.jsx(d,{gap:"xs",children:i.map((r,n)=>e.jsx(z,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",r.shard]}),e.jsxs("div",{children:["Type: ",r.primary?"Primary":"Replica"]}),e.jsx("div",{children:"State: UNASSIGNED"}),e.jsx("div",{children:"Reason: Not allocated to any node"})]}),children:e.jsx(u,{size:"lg",variant:r.primary?"filled":"light",color:"red",children:r.shard})},`unassigned-${r.index}-${r.shard}-${n}`))})]})},s))})]}),e.jsxs(f,{shadow:"sm",padding:"lg",mb:"md",children:[e.jsx(_,{order:3,mb:"md",children:"Shard Allocation by Node"}),e.jsx(m,{gap:"md",children:Ee.map(s=>{const i=Y[s],r=F==null?void 0:F.find(o=>o.name===s),n=i.filter(o=>o.primary).length,S=i.filter(o=>!o.primary).length;return e.jsx(f,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(m,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(a,{size:"sm",fw:500,children:s}),r&&N&&e.jsxs(e.Fragment,{children:[e.jsx(a,{size:"xs",c:"dimmed",children:r.ip}),e.jsxs(a,{size:"xs",c:"dimmed",children:["Roles: ",r.roles.join(", ")]})]})]}),e.jsxs(d,{gap:"xs",children:[e.jsxs(u,{size:"sm",variant:"light",color:"blue",children:[n,"p"]}),e.jsxs(u,{size:"sm",variant:"light",color:"gray",children:[S,"r"]}),e.jsxs(u,{size:"sm",variant:"light",children:[i.length," total"]})]})]}),r&&e.jsxs(d,{gap:"md",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(a,{size:"xs",c:"dimmed",children:"Heap"}),e.jsx(me,{value:Math.round(r.heapUsed/r.heapMax*100),color:ie(Math.round(r.heapUsed/r.heapMax*100)),size:"sm",radius:"xs"}),N&&e.jsxs(a,{size:"xs",c:"dimmed",children:[R(r.heapUsed)," / ",R(r.heapMax)]})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(a,{size:"xs",c:"dimmed",children:"Disk"}),e.jsx(me,{value:Math.round(r.diskUsed/r.diskTotal*100),color:ie(Math.round(r.diskUsed/r.diskTotal*100)),size:"sm",radius:"xs"}),N&&e.jsxs(a,{size:"xs",c:"dimmed",children:[R(r.diskUsed)," / ",R(r.diskTotal)]})]})]})]})},s)})})]}),e.jsxs(f,{shadow:"sm",padding:"lg",children:[e.jsxs(_,{order:3,mb:"md",children:["Shards by Index (",X.length," ",X.length===1?"index":"indices",")"]}),e.jsx(ue,{children:e.jsx(m,{gap:"md",children:X.map(s=>{const i=Q[s],r=i.some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING");return e.jsx(f,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(m,{gap:"xs",children:[e.jsxs(d,{justify:"space-between",children:[e.jsx(a,{size:"sm",fw:500,children:s}),r&&e.jsx(u,{size:"sm",color:"yellow",children:"Has Issues"})]}),e.jsx(d,{gap:"xs",children:i.map((n,S)=>e.jsx(z,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",n.shard]}),e.jsxs("div",{children:["Type: ",n.primary?"Primary":"Replica"]}),e.jsxs("div",{children:["State: ",n.state]}),e.jsxs("div",{children:["Node: ",n.node||"N/A"]}),n.docs!==void 0&&n.docs!==null&&e.jsxs("div",{children:["Docs: ",n.docs.toLocaleString()]}),n.store!==void 0&&n.store!==null&&e.jsxs("div",{children:["Size: ",R(n.store)]})]}),children:e.jsx(u,{size:"lg",variant:n.primary?"filled":"light",color:n.state==="STARTED"?"green":n.state==="UNASSIGNED"?"red":"yellow",style:{cursor:"pointer"},onClick:o=>{o.ctrlKey||o.metaKey||o.button===2?n.state==="STARTED"&&n.node&&(o.preventDefault(),le(n)):Ce(n)},onContextMenu:o=>{n.state==="STARTED"&&n.node&&(o.preventDefault(),le(n))},children:n.shard})},`${n.index}-${n.shard}-${S}`))})]})},s)})})})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx(Ze,{opened:H,onClose:()=>{D(!1),I(null)},shard:l,nodes:F||[],onRelocate:s=>{l.node&&te.mutate({index:l.index,shard:l.shard,fromNode:l.node,toNode:s})},isLoading:te.isPending}),e.jsx(je,{opened:v,onClose:()=>{x(!1),A(null)},title:l?e.jsxs(d,{gap:"xs",children:[e.jsx(a,{size:"lg",fw:600,children:"Shard Details:"}),e.jsx(u,{size:"lg",variant:"light",color:"blue",children:l.index}),e.jsx(a,{size:"lg",c:"dimmed",children:"/"}),e.jsxs(u,{size:"lg",variant:"filled",color:"cyan",children:["#",l.shard]}),e.jsx(u,{size:"lg",variant:l.primary?"filled":"light",color:l.primary?"green":"gray",children:l.primary?"Primary":"Replica"})]}):"Shard Details",size:"80%",fullScreen:!1,styles:{body:{height:"calc(100vh - 120px)",display:"flex",flexDirection:"column"}},children:e.jsx(ue,{style:{flex:1},children:fe?e.jsxs(m,{gap:"xs",children:[e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,width:"70%",radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,width:"50%",radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,radius:"xs"}),e.jsx(g,{height:20,width:"80%",radius:"xs"})]}):e.jsx(Pe,{block:!0,children:JSON.stringify(pe||l,null,2)})})})]})]})}function R(t){if(t===0)return"0 B";const h=1024,c=["B","KB","MB","GB","TB"],w=Math.floor(Math.log(t)/Math.log(h));return`${(t/Math.pow(h,w)).toFixed(2)} ${c[w]}`}function Ze({opened:t,onClose:h,shard:c,nodes:w,onRelocate:H,isLoading:D}){const l=Ve({initialValues:{targetNode:""},validate:{targetNode:x=>x?null:"Target node is required"}}),I=w.filter(x=>x.name!==c.node).map(x=>({value:x.name,label:`${x.name} (${x.roles.join(", ")})`})),v=l.onSubmit(x=>{H(x.targetNode)});return e.jsx(je,{opened:t,onClose:h,title:"Relocate Shard",size:"md",children:e.jsx("form",{onSubmit:v,children:e.jsxs(m,{gap:"md",children:[e.jsx(L,{icon:e.jsx(P,{size:16}),title:"Shard Information",color:"blue",children:e.jsxs(m,{gap:"xs",children:[e.jsxs(a,{size:"sm",children:[e.jsx("strong",{children:"Index:"})," ",c.index]}),e.jsxs(a,{size:"sm",children:[e.jsx("strong",{children:"Shard:"})," ",c.shard]}),e.jsxs(a,{size:"sm",children:[e.jsx("strong",{children:"Type:"})," ",c.primary?"Primary":"Replica"]}),e.jsxs(a,{size:"sm",children:[e.jsx("strong",{children:"Current Node:"})," ",c.node]})]})}),e.jsx(qe,{label:"Target Node",placeholder:"Select target node",data:I,searchable:!0,required:!0,...l.getInputProps("targetNode")}),e.jsx(L,{icon:e.jsx(P,{size:16}),title:"Warning",color:"yellow",children:e.jsx(a,{size:"sm",children:"Relocating shards can impact cluster performance. Ensure the target node has sufficient resources."})}),e.jsxs(d,{justify:"flex-end",mt:"md",children:[e.jsx(ge,{variant:"subtle",onClick:h,children:"Cancel"}),e.jsx(ge,{type:"submit",loading:D,children:"Relocate Shard"})]})]})})})}export{xs as ShardManagement};
