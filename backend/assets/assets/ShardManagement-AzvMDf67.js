import{c as L,K as $,y as F,r as R,b as B,j as e,A as z,I as T,G as m,L as U,T as w,d as n,S as p,P as G,e as r,J as O,D as C,f as N}from"./index-sr7dq9R1.js";import{u as K}from"./useMutation-BN6Dat8K.js";import{C as S}from"./Container-BEJSZFYx.js";import{C as y}from"./Card-CZ902M55.js";import{B as j}from"./Badge-CqbBvupe.js";import{P as E}from"./Progress-C9FvU4_v.js";import{B as M}from"./Button-Dg8g4WG0.js";import{u as Q}from"./use-form-Dvprg3Gu.js";import{S as _}from"./Select-B2tlua6l.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./OptionsDropdown-6hS3_-8B.js";import"./InputBase-OpV6tttC.js";var H=L("arrow-right","IconArrowRight",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M13 18l6 -6",key:"svg-1"}],["path",{d:"M13 6l6 6",key:"svg-2"}]]);function oe(){const{id:l}=$(),x=F(),[a,c]=R.useState(!1),[h,u]=R.useState(null),{data:d,isLoading:b,error:f}=B({queryKey:["cluster",l,"shards"],queryFn:()=>N.getShards(l),enabled:!!l}),{data:o,isLoading:I}=B({queryKey:["cluster",l,"nodes"],queryFn:()=>N.getNodes(l),enabled:!!l}),A=K({mutationFn:({index:s,shard:t,fromNode:i,toNode:v})=>N.proxyRequest(l,"POST","/_cluster/reroute",{commands:[{move:{index:s,shard:t,from_node:i,to_node:v}}]}),onSuccess:()=>{x.invalidateQueries({queryKey:["cluster",l,"shards"]}),C.show({title:"Success",message:"Shard relocation initiated successfully",color:"green"}),c(!1),u(null)},onError:s=>{C.show({title:"Error",message:`Failed to relocate shard: ${s.message}`,color:"red"})}}),k=s=>{u(s),c(!0)};if(!l)return e.jsx(S,{size:"xl",children:e.jsx(z,{icon:e.jsx(T,{size:16}),title:"Error",color:"red",children:"Cluster ID is required"})});if(b||I)return e.jsx(S,{size:"xl",children:e.jsx(m,{justify:"center",mt:"xl",children:e.jsx(U,{size:"lg"})})});if(f)return e.jsx(S,{size:"xl",children:e.jsxs(z,{icon:e.jsx(T,{size:16}),title:"Error",color:"red",children:["Failed to load shards: ",f.message]})});const q=(d==null?void 0:d.reduce((s,t)=>(s[t.state]||(s[t.state]=[]),s[t.state].push(t),s),{}))||{},D=(d==null?void 0:d.reduce((s,t)=>{const i=t.node||"UNASSIGNED";return s[i]||(s[i]=[]),s[i].push(t),s},{}))||{};return e.jsxs(S,{size:"xl",py:"md",children:[e.jsx(m,{justify:"space-between",mb:"md",children:e.jsxs("div",{children:[e.jsx(w,{order:2,children:"Shard Management"}),e.jsx(n,{size:"sm",c:"dimmed",children:"View and manage shard allocation across nodes"})]})}),e.jsx(m,{mb:"md",grow:!0,children:Object.entries(q).map(([s,t])=>e.jsx(y,{shadow:"sm",padding:"md",children:e.jsxs(p,{gap:"xs",children:[e.jsx(n,{size:"sm",c:"dimmed",children:s}),e.jsx(n,{size:"xl",fw:700,children:t.length}),e.jsx(j,{size:"sm",color:s==="STARTED"?"green":s==="UNASSIGNED"?"red":"yellow",children:s})]})},s))}),e.jsxs(y,{shadow:"sm",padding:"lg",mb:"md",children:[e.jsx(w,{order:3,mb:"md",children:"Shard Allocation by Node"}),e.jsx(p,{gap:"md",children:Object.entries(D).map(([s,t])=>{const i=o==null?void 0:o.find(g=>g.name===s),v=t.filter(g=>g.primary).length,P=t.filter(g=>!g.primary).length;return e.jsx(y,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(p,{gap:"xs",children:[e.jsxs(m,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(n,{size:"sm",fw:500,children:s}),i&&e.jsx(n,{size:"xs",c:"dimmed",children:i.ip})]}),e.jsxs(m,{gap:"xs",children:[e.jsxs(j,{size:"sm",variant:"light",color:"blue",children:[v,"p"]}),e.jsxs(j,{size:"sm",variant:"light",color:"gray",children:[P,"r"]}),e.jsxs(j,{size:"sm",variant:"light",children:[t.length," total"]})]})]}),i&&e.jsxs(m,{gap:"md",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(n,{size:"xs",c:"dimmed",children:"Heap"}),e.jsx(E,{value:Math.round(i.heapUsed/i.heapMax*100),color:i.heapUsed/i.heapMax>.9?"red":"blue",size:"sm"})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(n,{size:"xs",c:"dimmed",children:"Disk"}),e.jsx(E,{value:Math.round(i.diskUsed/i.diskTotal*100),color:i.diskUsed/i.diskTotal>.9?"red":"blue",size:"sm"})]})]})]})},s)})})]}),e.jsxs(y,{shadow:"sm",padding:"lg",children:[e.jsx(w,{order:3,mb:"md",children:"All Shards"}),e.jsxs(G,{children:[e.jsxs(r,{striped:!0,highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"Index"}),e.jsx(r.Th,{children:"Shard"}),e.jsx(r.Th,{children:"Type"}),e.jsx(r.Th,{children:"State"}),e.jsx(r.Th,{children:"Node"}),e.jsx(r.Th,{children:"Documents"}),e.jsx(r.Th,{children:"Size"}),e.jsx(r.Th,{children:"Actions"})]})}),e.jsx(r.Tbody,{children:d==null?void 0:d.slice(0,100).map((s,t)=>{var i;return e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:e.jsx(n,{size:"sm",children:s.index})}),e.jsx(r.Td,{children:e.jsx(n,{size:"sm",children:s.shard})}),e.jsx(r.Td,{children:e.jsx(j,{size:"sm",variant:"light",color:s.primary?"blue":"gray",children:s.primary?"Primary":"Replica"})}),e.jsx(r.Td,{children:e.jsx(j,{size:"sm",color:s.state==="STARTED"?"green":s.state==="UNASSIGNED"?"red":"yellow",children:s.state})}),e.jsx(r.Td,{children:e.jsx(n,{size:"sm",children:s.node||"N/A"})}),e.jsx(r.Td,{children:e.jsx(n,{size:"sm",children:((i=s.docs)==null?void 0:i.toLocaleString())||"N/A"})}),e.jsx(r.Td,{children:e.jsx(n,{size:"sm",children:s.store?V(s.store):"N/A"})}),e.jsx(r.Td,{children:s.state==="STARTED"&&s.node&&e.jsx(M,{size:"xs",variant:"light",leftSection:e.jsx(H,{size:14}),onClick:()=>k(s),children:"Relocate"})})]},`${s.index}-${s.shard}-${t}`)})})]}),d&&d.length>100&&e.jsxs(n,{size:"sm",c:"dimmed",ta:"center",mt:"md",children:["Showing first 100 of ",d.length," shards"]})]})]}),h&&e.jsx(J,{opened:a,onClose:()=>{c(!1),u(null)},shard:h,nodes:o||[],onRelocate:s=>{h.node&&A.mutate({index:h.index,shard:h.shard,fromNode:h.node,toNode:s})},isLoading:A.isPending})]})}function V(l){if(l===0)return"0 B";const x=1024,a=["B","KB","MB","GB","TB"],c=Math.floor(Math.log(l)/Math.log(x));return`${(l/Math.pow(x,c)).toFixed(2)} ${a[c]}`}function J({opened:l,onClose:x,shard:a,nodes:c,onRelocate:h,isLoading:u}){const d=Q({initialValues:{targetNode:""},validate:{targetNode:o=>o?null:"Target node is required"}}),b=c.filter(o=>o.name!==a.node).map(o=>({value:o.name,label:`${o.name} (${o.roles.join(", ")})`})),f=d.onSubmit(o=>{h(o.targetNode)});return e.jsx(O,{opened:l,onClose:x,title:"Relocate Shard",size:"md",children:e.jsx("form",{onSubmit:f,children:e.jsxs(p,{gap:"md",children:[e.jsx(z,{icon:e.jsx(T,{size:16}),title:"Shard Information",color:"blue",children:e.jsxs(p,{gap:"xs",children:[e.jsxs(n,{size:"sm",children:[e.jsx("strong",{children:"Index:"})," ",a.index]}),e.jsxs(n,{size:"sm",children:[e.jsx("strong",{children:"Shard:"})," ",a.shard]}),e.jsxs(n,{size:"sm",children:[e.jsx("strong",{children:"Type:"})," ",a.primary?"Primary":"Replica"]}),e.jsxs(n,{size:"sm",children:[e.jsx("strong",{children:"Current Node:"})," ",a.node]})]})}),e.jsx(_,{label:"Target Node",placeholder:"Select target node",data:b,searchable:!0,required:!0,...d.getInputProps("targetNode")}),e.jsx(z,{icon:e.jsx(T,{size:16}),title:"Warning",color:"yellow",children:e.jsx(n,{size:"sm",children:"Relocating shards can impact cluster performance. Ensure the target node has sufficient resources."})}),e.jsxs(m,{justify:"flex-end",mt:"md",children:[e.jsx(M,{variant:"subtle",onClick:x,children:"Cancel"}),e.jsx(M,{type:"submit",loading:u,children:"Relocate Shard"})]})]})})})}export{oe as ShardManagement};
