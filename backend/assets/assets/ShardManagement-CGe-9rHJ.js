import{q as ye,h as be,s as ze,r as F,b as H,j as e,A,I as k,G as o,L as Ie,T as O,d as l,M as S,k as y,l as T,m as we,S as h,v as ve,n as I,f as w,p as Ne,a9 as Ce}from"./index-DBXJwFrG.js";import{u as W}from"./useMutation-CXXLJbQh.js";import{C as $}from"./Container-DiAZ7uuc.js";import{C as p}from"./Card-CQodkCwr.js";import{I as Te,a as K,b as Ee,c as Ae,C as ke}from"./IconMinimize-D-LeDRM_.js";import{I as Me,a as Re}from"./IconSortDescending-D7uKFFsa.js";import{T as Le}from"./TextInput-66ik4YLx.js";import{I as qe}from"./IconFilter-DkqS19ok.js";import{B as j}from"./Badge-qkeekHDa.js";import{P as le}from"./Progress-DLCqdF-V.js";import{u as De}from"./use-form-CJBLN_W2.js";import{B as ae}from"./Button-CSbwBdil.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./InputsGroupFieldset-DxKzOPQG.js";function Ye(){var se,re,ie;const{id:t}=ye(),c=be(),[d,b]=ze(),[Q,v]=F.useState(!1),[x,N]=F.useState(null),g=d.get("expanded")==="true",a=d.get("sort")!=="desc",_=d.get("affected")==="true",z=d.get("filter")||"",M=(s,r)=>{const i=new URLSearchParams(d);r===""||r===!1?i.delete(s):i.set(s,String(r)),b(i)},oe=s=>M("expanded",s),de=s=>M("sort",s?"asc":"desc"),ce=s=>M("affected",s),he=s=>M("filter",s),{data:m,isLoading:xe,error:J}=H({queryKey:["cluster",t,"shards"],queryFn:()=>w.getShards(t),enabled:!!t}),{data:R,isLoading:me}=H({queryKey:["cluster",t,"nodes"],queryFn:()=>w.getNodes(t),enabled:!!t}),{data:L,isLoading:ue}=H({queryKey:["cluster",t,"settings"],queryFn:async()=>await w.proxyRequest(t,"GET","/_cluster/settings"),enabled:!!t}),je=F.useMemo(()=>{var ne,te;if(!L)return!0;const s=L.transient,r=L.persistent,i=s==null?void 0:s.cluster,n=r==null?void 0:r.cluster,f=i==null?void 0:i.routing,u=n==null?void 0:n.routing,fe=(ne=f==null?void 0:f.allocation)==null?void 0:ne.enable,Se=(te=u==null?void 0:u.allocation)==null?void 0:te.enable;return(fe||Se||"all")==="all"},[L]),X=W({mutationFn:()=>w.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":"all"}}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"settings"]}),I.show({title:"Success",message:"Shard allocation enabled",color:"green"})},onError:s=>{I.show({title:"Error",message:`Failed to enable shard allocation: ${s.message}`,color:"red"})}}),q=W({mutationFn:s=>w.proxyRequest(t,"PUT","/_cluster/settings",{transient:{"cluster.routing.allocation.enable":s}}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"settings"]}),I.show({title:"Success",message:"Shard allocation disabled",color:"green"})},onError:s=>{I.show({title:"Error",message:`Failed to disable shard allocation: ${s.message}`,color:"red"})}}),Y=W({mutationFn:({index:s,shard:r,fromNode:i,toNode:n})=>w.proxyRequest(t,"POST","/_cluster/reroute",{commands:[{move:{index:s,shard:r,from_node:i,to_node:n}}]}),onSuccess:()=>{c.invalidateQueries({queryKey:["cluster",t,"shards"]}),I.show({title:"Success",message:"Shard relocation initiated successfully",color:"green"}),v(!1),N(null)},onError:s=>{I.show({title:"Error",message:`Failed to relocate shard: ${s.message}`,color:"red"})}}),ge=s=>{N(s),v(!0)};if(!t)return e.jsx($,{size:"xl",children:e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Error",color:"red",children:"Cluster ID is required"})});if(xe||me||ue)return e.jsx($,{size:"xl",children:e.jsx(o,{justify:"center",mt:"xl",children:e.jsx(Ie,{size:"lg"})})});if(J)return e.jsx($,{size:"xl",children:e.jsxs(A,{icon:e.jsx(k,{size:16}),title:"Error",color:"red",children:["Failed to load shards: ",J.message]})});const D=(m==null?void 0:m.reduce((s,r)=>(s[r.state]||(s[r.state]=[]),s[r.state].push(r),s),{}))||{},P=((se=D.UNASSIGNED)==null?void 0:se.length)||0,G=((re=D.RELOCATING)==null?void 0:re.length)||0,U=((ie=D.INITIALIZING)==null?void 0:ie.length)||0,ee=P>0||G>0||U>0,B=(m==null?void 0:m.reduce((s,r)=>(s[r.index]||(s[r.index]=[]),s[r.index].push(r),s),{}))||{},V=F.useMemo(()=>{let s=Object.keys(B);return z&&(s=s.filter(r=>r.toLowerCase().includes(z.toLowerCase()))),_&&(s=s.filter(r=>B[r].some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING"))),s.sort((r,i)=>a?r.localeCompare(i):i.localeCompare(r)),s},[B,z,_,a]),Z=(m==null?void 0:m.reduce((s,r)=>{const i=r.node||"UNASSIGNED";return s[i]||(s[i]=[]),s[i].push(r),s},{}))||{},C=Z.UNASSIGNED||[],pe=Object.keys(Z).filter(s=>s!=="UNASSIGNED");return e.jsxs($,{size:"xl",py:"md",children:[e.jsx(o,{justify:"space-between",mb:"md",children:e.jsxs("div",{children:[e.jsx(O,{order:2,children:"Shard Management"}),e.jsx(l,{size:"sm",c:"dimmed",children:"View and manage shard allocation across nodes"})]})}),e.jsx(p,{shadow:"sm",padding:"md",mb:"md",children:e.jsxs(o,{justify:"space-between",children:[e.jsxs(o,{children:[je?e.jsxs(S,{shadow:"md",width:200,children:[e.jsx(S.Target,{children:e.jsx(y,{label:"Disable shard allocation",children:e.jsx(T,{size:"lg",variant:"subtle",color:"green",loading:q.isPending,children:e.jsx(Te,{size:20})})})}),e.jsxs(S.Dropdown,{children:[e.jsx(S.Label,{children:"Disable Allocation"}),e.jsxs(S.Item,{onClick:()=>q.mutate("none"),children:[e.jsx(K,{size:14})," None (default)"]}),e.jsxs(S.Item,{onClick:()=>q.mutate("primaries"),children:[e.jsx(K,{size:14})," Primaries only"]}),e.jsxs(S.Item,{onClick:()=>q.mutate("new_primaries"),children:[e.jsx(K,{size:14})," New primaries only"]})]})]}):e.jsx(y,{label:"Enable shard allocation",children:e.jsx(T,{size:"lg",variant:"subtle",color:"red",onClick:()=>X.mutate(),loading:X.isPending,children:e.jsx(K,{size:20})})}),e.jsx(y,{label:g?"Compress view":"Expand view",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>oe(!g),children:g?e.jsx(Ee,{size:20}):e.jsx(Ae,{size:20})})}),e.jsx(y,{label:a?"Sort descending":"Sort ascending",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>de(!a),children:a?e.jsx(Me,{size:20}):e.jsx(Re,{size:20})})}),e.jsx(y,{label:"Refresh data",children:e.jsx(T,{size:"lg",variant:"subtle",onClick:()=>{c.invalidateQueries({queryKey:["cluster",t,"shards"]}),c.invalidateQueries({queryKey:["cluster",t,"nodes"]}),c.invalidateQueries({queryKey:["cluster",t,"settings"]})},children:e.jsx(we,{size:20})})})]}),e.jsxs(o,{children:[e.jsx(Le,{placeholder:"Filter indices...",leftSection:e.jsx(qe,{size:16}),value:z,onChange:s=>he(s.currentTarget.value),style:{width:200}}),ee&&e.jsx(ke,{label:"Show only affected",checked:_,onChange:s=>ce(s.currentTarget.checked)})]})]})}),ee&&e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Shard Issues Detected",color:"yellow",mb:"md",children:e.jsxs(h,{gap:"xs",children:[P>0&&e.jsxs(l,{size:"sm",children:["âš ï¸ ",P," unassigned shard",P>1?"s":""]}),G>0&&e.jsxs(l,{size:"sm",children:["ðŸ”„ ",G," relocating shard",G>1?"s":""]}),U>0&&e.jsxs(l,{size:"sm",children:["â³ ",U," initializing shard",U>1?"s":""]})]})}),e.jsx(o,{mb:"md",grow:!0,children:Object.entries(D).map(([s,r])=>e.jsx(p,{shadow:"sm",padding:"md",children:e.jsxs(h,{gap:"xs",children:[e.jsx(l,{size:"sm",c:"dimmed",children:s}),e.jsx(l,{size:"xl",fw:700,children:r.length}),e.jsx(j,{size:"sm",color:s==="STARTED"?"green":s==="UNASSIGNED"?"red":"yellow",children:s})]})},s))}),C.length>0&&e.jsxs(p,{shadow:"sm",padding:"lg",mb:"md",style:{backgroundColor:"var(--mantine-color-red-0)"},children:[e.jsxs(o,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx(O,{order:3,children:"Unassigned Shards"}),e.jsxs(l,{size:"sm",c:"dimmed",children:[C.length," shard",C.length>1?"s":""," not allocated to any node"]})]}),e.jsx(j,{size:"lg",color:"red",variant:"filled",children:C.length})]}),e.jsx(h,{gap:"md",children:Object.entries(C.reduce((s,r)=>(s[r.index]||(s[r.index]=[]),s[r.index].push(r),s),{})).filter(([s])=>!(z&&!s.toLowerCase().includes(z.toLowerCase()))).sort(([s],[r])=>a?s.localeCompare(r):r.localeCompare(s)).map(([s,r])=>e.jsx(p,{shadow:"xs",padding:"sm",withBorder:!0,style:{backgroundColor:"white"},children:e.jsxs(h,{gap:"xs",children:[e.jsxs(o,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),e.jsxs(j,{size:"sm",color:"red",variant:"light",children:[r.length," unassigned"]})]}),e.jsx(o,{gap:"xs",children:r.map((i,n)=>e.jsx(y,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",i.shard]}),e.jsxs("div",{children:["Type: ",i.primary?"Primary":"Replica"]}),e.jsx("div",{children:"State: UNASSIGNED"}),e.jsx("div",{children:"Reason: Not allocated to any node"})]}),children:e.jsx(j,{size:"lg",variant:i.primary?"filled":"light",color:"red",children:i.shard})},`unassigned-${i.index}-${i.shard}-${n}`))})]})},s))})]}),e.jsxs(p,{shadow:"sm",padding:"lg",mb:"md",children:[e.jsx(O,{order:3,mb:"md",children:"Shard Allocation by Node"}),e.jsx(h,{gap:"md",children:pe.map(s=>{const r=Z[s],i=R==null?void 0:R.find(u=>u.name===s),n=r.filter(u=>u.primary).length,f=r.filter(u=>!u.primary).length;return e.jsx(p,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(h,{gap:"xs",children:[e.jsxs(o,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(l,{size:"sm",fw:500,children:s}),i&&g&&e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"xs",c:"dimmed",children:i.ip}),e.jsxs(l,{size:"xs",c:"dimmed",children:["Roles: ",i.roles.join(", ")]})]})]}),e.jsxs(o,{gap:"xs",children:[e.jsxs(j,{size:"sm",variant:"light",color:"blue",children:[n,"p"]}),e.jsxs(j,{size:"sm",variant:"light",color:"gray",children:[f,"r"]}),e.jsxs(j,{size:"sm",variant:"light",children:[r.length," total"]})]})]}),i&&e.jsxs(o,{gap:"md",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Heap"}),e.jsx(le,{value:Math.round(i.heapUsed/i.heapMax*100),color:i.heapUsed/i.heapMax>.9?"red":"blue",size:"sm"}),g&&e.jsxs(l,{size:"xs",c:"dimmed",children:[E(i.heapUsed)," / ",E(i.heapMax)]})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(l,{size:"xs",c:"dimmed",children:"Disk"}),e.jsx(le,{value:Math.round(i.diskUsed/i.diskTotal*100),color:i.diskUsed/i.diskTotal>.9?"red":"blue",size:"sm"}),g&&e.jsxs(l,{size:"xs",c:"dimmed",children:[E(i.diskUsed)," / ",E(i.diskTotal)]})]})]})]})},s)})})]}),e.jsxs(p,{shadow:"sm",padding:"lg",children:[e.jsxs(O,{order:3,mb:"md",children:["Shards by Index (",V.length," ",V.length===1?"index":"indices",")"]}),e.jsx(ve,{children:e.jsx(h,{gap:"md",children:V.map(s=>{const r=B[s],i=r.some(n=>n.state==="UNASSIGNED"||n.state==="RELOCATING"||n.state==="INITIALIZING");return e.jsx(p,{shadow:"xs",padding:"md",withBorder:!0,children:e.jsxs(h,{gap:"xs",children:[e.jsxs(o,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:500,children:s}),i&&e.jsx(j,{size:"sm",color:"yellow",children:"Has Issues"})]}),e.jsx(o,{gap:"xs",children:r.map((n,f)=>e.jsx(y,{label:e.jsxs("div",{children:[e.jsxs("div",{children:["Shard: ",n.shard]}),e.jsxs("div",{children:["Type: ",n.primary?"Primary":"Replica"]}),e.jsxs("div",{children:["State: ",n.state]}),e.jsxs("div",{children:["Node: ",n.node||"N/A"]}),n.docs&&e.jsxs("div",{children:["Docs: ",n.docs.toLocaleString()]}),n.store&&e.jsxs("div",{children:["Size: ",E(n.store)]})]}),children:e.jsx(j,{size:"lg",variant:n.primary?"filled":"light",color:n.state==="STARTED"?"green":n.state==="UNASSIGNED"?"red":"yellow",style:{cursor:n.state==="STARTED"&&n.node?"pointer":"default"},onClick:()=>{n.state==="STARTED"&&n.node&&ge(n)},children:n.shard})},`${n.index}-${n.shard}-${f}`))})]})},s)})})})]}),x&&e.jsx(Pe,{opened:Q,onClose:()=>{v(!1),N(null)},shard:x,nodes:R||[],onRelocate:s=>{x.node&&Y.mutate({index:x.index,shard:x.shard,fromNode:x.node,toNode:s})},isLoading:Y.isPending})]})}function E(t){if(t===0)return"0 B";const c=1024,d=["B","KB","MB","GB","TB"],b=Math.floor(Math.log(t)/Math.log(c));return`${(t/Math.pow(c,b)).toFixed(2)} ${d[b]}`}function Pe({opened:t,onClose:c,shard:d,nodes:b,onRelocate:Q,isLoading:v}){const x=De({initialValues:{targetNode:""},validate:{targetNode:a=>a?null:"Target node is required"}}),N=b.filter(a=>a.name!==d.node).map(a=>({value:a.name,label:`${a.name} (${a.roles.join(", ")})`})),g=x.onSubmit(a=>{Q(a.targetNode)});return e.jsx(Ne,{opened:t,onClose:c,title:"Relocate Shard",size:"md",children:e.jsx("form",{onSubmit:g,children:e.jsxs(h,{gap:"md",children:[e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Shard Information",color:"blue",children:e.jsxs(h,{gap:"xs",children:[e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Index:"})," ",d.index]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Shard:"})," ",d.shard]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Type:"})," ",d.primary?"Primary":"Replica"]}),e.jsxs(l,{size:"sm",children:[e.jsx("strong",{children:"Current Node:"})," ",d.node]})]})}),e.jsx(Ce,{label:"Target Node",placeholder:"Select target node",data:N,searchable:!0,required:!0,...x.getInputProps("targetNode")}),e.jsx(A,{icon:e.jsx(k,{size:16}),title:"Warning",color:"yellow",children:e.jsx(l,{size:"sm",children:"Relocating shards can impact cluster performance. Ensure the target node has sufficient resources."})}),e.jsxs(o,{justify:"flex-end",mt:"md",children:[e.jsx(ae,{variant:"subtle",onClick:c,children:"Cancel"}),e.jsx(ae,{type:"submit",loading:v,children:"Relocate Shard"})]})]})})})}export{Ye as ShardManagement};
