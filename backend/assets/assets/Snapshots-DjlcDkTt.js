import{e as $,z as _,q as T,r as R,k as E,j as e,A as I,I as z,G as j,L as B,aj as K,l as Q,m as o,H as q,S as k,F as W,n,v as H,t as S,o as b,y as F}from"./index-BQLFZ8Ya.js";import{u as A}from"./useMutation-CW5IrkPL.js";import{C as v}from"./Container-CSINMlMa.js";import{B as d}from"./Button-BVlCtt37.js";import{I as V}from"./IconArrowLeft-C15HSvU0.js";import{C as X}from"./Card-CJROusMN.js";import{B as J}from"./Badge-Cqqyn2Ie.js";import{P as Y}from"./Progress-D_76HT5g.js";import{I as Z}from"./IconTrash-dfG7lxII.js";import{I as ee}from"./IconClock-DU_BIhXT.js";import{I as se}from"./IconCheck-Diahw5QR.js";import{u as G}from"./use-form-FRU0Hu1Y.js";import{T as P}from"./TextInput-BHrqeJuX.js";import{M as L}from"./MultiSelect--Lc27yUC.js";import{S as p}from"./Switch-5PMZVMMa.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./InputsGroupFieldset-Zc1JFeox.js";var te=$("restore","IconRestore",[["path",{d:"M3.06 13a9 9 0 1 0 .49 -4.087",key:"svg-0"}],["path",{d:"M3 4.001v5h5",key:"svg-1"}],["path",{d:"M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-2"}]]),re=$("x","IconX",[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]]);function ve(){const{id:a,repository:i}=_(),h=T(),[m,l]=R.useState(!1),[f,t]=R.useState(!1),[c,x]=R.useState(null),{data:r,isLoading:O,error:w}=E({queryKey:["cluster",a,"snapshots",i],queryFn:()=>b.getSnapshots(a,i),enabled:!!a&&!!i,refetchInterval:s=>{const u=s.state.data;return(u==null?void 0:u.some(y=>y.state==="IN_PROGRESS"))?5e3:!1}}),{data:C}=E({queryKey:["cluster",a,"indices"],queryFn:()=>b.getIndices(a),enabled:!!a}),M=A({mutationFn:s=>b.deleteSnapshot(a,i,s),onSuccess:()=>{h.invalidateQueries({queryKey:["cluster",a,"snapshots",i]}),S.show({title:"Success",message:"Snapshot deleted successfully",color:"green"})},onError:s=>{S.show({title:"Error",message:`Failed to delete snapshot: ${s.message}`,color:"red"})}});if(!a||!i)return e.jsx(v,{size:"xl",children:e.jsx(I,{icon:e.jsx(z,{size:16}),title:"Error",color:"red",children:"Cluster ID and repository name are required"})});if(O)return e.jsx(v,{size:"xl",children:e.jsx(j,{justify:"center",mt:"xl",children:e.jsx(B,{size:"lg"})})});if(w)return e.jsx(v,{size:"xl",children:e.jsxs(I,{icon:e.jsx(z,{size:16}),title:"Error",color:"red",children:["Failed to load snapshots: ",w.message]})});const U=s=>{switch(s){case"SUCCESS":return"green";case"IN_PROGRESS":return"blue";case"FAILED":return"red";case"PARTIAL":return"yellow";default:return"gray"}},N=s=>{switch(s){case"SUCCESS":return e.jsx(se,{size:16});case"IN_PROGRESS":return e.jsx(ee,{size:16});case"FAILED":return e.jsx(re,{size:16});case"PARTIAL":return e.jsx(z,{size:16});default:return null}},D=s=>{if(!s)return"N/A";const u=Math.floor(s/1e3),g=Math.floor(u/60),y=Math.floor(g/60);return y>0?`${y}h ${g%60}m`:g>0?`${g}m ${u%60}s`:`${u}s`};return e.jsxs(v,{size:"xl",py:"md",children:[e.jsxs(j,{justify:"space-between",mb:"md",children:[e.jsxs("div",{children:[e.jsx(j,{gap:"xs",mb:"xs",children:e.jsx(d,{component:K,to:`/cluster/${a}/repositories`,variant:"subtle",size:"xs",leftSection:e.jsx(V,{size:16}),children:"Back to Repositories"})}),e.jsxs(Q,{order:2,children:["Snapshots in ",i]}),e.jsx(o,{size:"sm",c:"dimmed",children:"Manage snapshots for backup and restore operations"})]}),e.jsx(d,{leftSection:e.jsx(q,{size:16}),onClick:()=>l(!0),children:"Create Snapshot"})]}),e.jsx(X,{shadow:"sm",padding:"lg",children:!r||r.length===0?e.jsxs(k,{gap:"md",align:"center",py:"xl",children:[e.jsx(o,{c:"dimmed",children:"No snapshots found in this repository"}),e.jsx(d,{leftSection:e.jsx(q,{size:16}),onClick:()=>l(!0),children:"Create Snapshot"})]}):e.jsx(W,{children:e.jsxs(n,{striped:!0,highlightOnHover:!0,children:[e.jsx(n.Thead,{children:e.jsxs(n.Tr,{children:[e.jsx(n.Th,{children:"Snapshot"}),e.jsx(n.Th,{children:"State"}),e.jsx(n.Th,{children:"Indices"}),e.jsx(n.Th,{children:"Shards"}),e.jsx(n.Th,{children:"Start Time"}),e.jsx(n.Th,{children:"Duration"}),e.jsx(n.Th,{children:"Actions"})]})}),e.jsx(n.Tbody,{children:r.map(s=>e.jsxs(n.Tr,{children:[e.jsxs(n.Td,{children:[e.jsx(o,{size:"sm",fw:500,children:s.snapshot}),e.jsx(o,{size:"xs",c:"dimmed",children:s.uuid})]}),e.jsxs(n.Td,{children:[e.jsx(J,{size:"sm",variant:"light",color:U(s.state),leftSection:N(s.state),children:s.state}),s.state==="IN_PROGRESS"&&s.shards&&e.jsx(Y,{value:s.shards.successful/s.shards.total*100,size:"sm",radius:"xs",mt:"xs"})]}),e.jsx(n.Td,{children:e.jsxs(o,{size:"sm",children:[s.indices.length," indices"]})}),e.jsx(n.Td,{children:s.shards?e.jsxs(o,{size:"sm",children:[s.shards.successful,"/",s.shards.total,s.shards.failed>0&&e.jsxs(o,{component:"span",c:"red",children:[" (",s.shards.failed," failed)"]})]}):e.jsx(o,{size:"sm",c:"dimmed",children:"N/A"})}),e.jsx(n.Td,{children:e.jsx(o,{size:"sm",children:new Date(s.startTime).toLocaleString()})}),e.jsx(n.Td,{children:e.jsx(o,{size:"sm",children:D(s.durationInMillis)})}),e.jsx(n.Td,{children:e.jsxs(j,{gap:"xs",children:[e.jsx(d,{size:"xs",variant:"light",leftSection:e.jsx(te,{size:14}),onClick:()=>{x(s),t(!0)},disabled:s.state!=="SUCCESS"&&s.state!=="PARTIAL",children:"Restore"}),e.jsx(H,{color:"red",variant:"subtle",onClick:()=>{confirm(`Delete snapshot "${s.snapshot}"?`)&&M.mutate(s.snapshot)},loading:M.isPending,disabled:s.state==="IN_PROGRESS",children:e.jsx(Z,{size:16})})]})})]},s.snapshot))})]})})}),e.jsx(ne,{opened:m,onClose:()=>l(!1),clusterId:a,repository:i,availableIndices:(C==null?void 0:C.map(s=>s.name))||[]}),c&&e.jsx(ie,{opened:f,onClose:()=>{t(!1),x(null)},clusterId:a,repository:i,snapshot:c})]})}function ne({opened:a,onClose:i,clusterId:h,repository:m,availableIndices:l}){const f=T(),t=G({initialValues:{snapshot:"",indices:[],ignoreUnavailable:!1,includeGlobalState:!0,partial:!1},validate:{snapshot:r=>r?r.startsWith("_")||r.startsWith("-")||r.startsWith("+")?"Snapshot name cannot start with _, -, or +":null:"Snapshot name is required"}}),c=A({mutationFn:r=>b.createSnapshot(h,m,r),onSuccess:()=>{f.invalidateQueries({queryKey:["cluster",h,"snapshots",m]}),S.show({title:"Success",message:"Snapshot creation started",color:"green"}),t.reset(),i()},onError:r=>{S.show({title:"Error",message:`Failed to create snapshot: ${r.message}`,color:"red"})}}),x=t.onSubmit(r=>{c.mutate(r)});return e.jsx(F,{opened:a,onClose:i,title:"Create Snapshot",size:"lg",children:e.jsx("form",{onSubmit:x,children:e.jsxs(k,{gap:"md",children:[e.jsx(P,{label:"Snapshot Name",placeholder:"snapshot-2024-01-01",required:!0,...t.getInputProps("snapshot")}),e.jsx(L,{label:"Indices",description:"Select specific indices to snapshot (leave empty for all indices)",placeholder:"Select indices",data:l,searchable:!0,clearable:!0,...t.getInputProps("indices")}),e.jsx(p,{label:"Ignore Unavailable Indices",description:"Continue snapshot even if some indices are unavailable",...t.getInputProps("ignoreUnavailable",{type:"checkbox"})}),e.jsx(p,{label:"Include Global State",description:"Include cluster global state in the snapshot",...t.getInputProps("includeGlobalState",{type:"checkbox"})}),e.jsx(p,{label:"Allow Partial Snapshot",description:"Allow snapshot to succeed even if some shards fail",...t.getInputProps("partial",{type:"checkbox"})}),e.jsx(I,{color:"blue",title:"Snapshot Information",children:e.jsx(o,{size:"sm",children:"Snapshots are incremental and only store data that has changed since the last snapshot. The snapshot process runs in the background and does not block indexing or search operations."})}),e.jsxs(j,{justify:"flex-end",mt:"md",children:[e.jsx(d,{variant:"subtle",onClick:i,children:"Cancel"}),e.jsx(d,{type:"submit",loading:c.isPending,children:"Create Snapshot"})]})]})})})}function ie({opened:a,onClose:i,clusterId:h,repository:m,snapshot:l}){const f=T(),t=G({initialValues:{indices:[],ignoreUnavailable:!1,includeGlobalState:!1,renamePattern:"",renameReplacement:"",includeAliases:!0,partial:!1}}),c=A({mutationFn:r=>b.restoreSnapshot(h,m,l.snapshot,r),onSuccess:()=>{f.invalidateQueries({queryKey:["cluster",h,"indices"]}),S.show({title:"Success",message:"Snapshot restore started",color:"green"}),t.reset(),i()},onError:r=>{S.show({title:"Error",message:`Failed to restore snapshot: ${r.message}`,color:"red"})}}),x=t.onSubmit(r=>{c.mutate(r)});return e.jsx(F,{opened:a,onClose:i,title:`Restore Snapshot: ${l.snapshot}`,size:"lg",children:e.jsx("form",{onSubmit:x,children:e.jsxs(k,{gap:"md",children:[e.jsx(I,{color:"blue",title:"Snapshot Contents",children:e.jsxs(o,{size:"sm",children:["This snapshot contains ",l.indices.length," indices: ",l.indices.join(", ")]})}),e.jsx(L,{label:"Indices to Restore",description:"Select specific indices to restore (leave empty to restore all)",placeholder:"Select indices",data:l.indices,searchable:!0,clearable:!0,...t.getInputProps("indices")}),e.jsx(P,{label:"Rename Pattern (Regex)",placeholder:"(.+)",description:"Regular expression pattern to match index names",...t.getInputProps("renamePattern")}),e.jsx(P,{label:"Rename Replacement",placeholder:"restored-$1",description:"Replacement pattern for renamed indices (use $1, $2 for capture groups)",...t.getInputProps("renameReplacement")}),e.jsx(p,{label:"Ignore Unavailable Indices",description:"Continue restore even if some indices are unavailable",...t.getInputProps("ignoreUnavailable",{type:"checkbox"})}),e.jsx(p,{label:"Include Global State",description:"Restore cluster global state from the snapshot",...t.getInputProps("includeGlobalState",{type:"checkbox"})}),e.jsx(p,{label:"Include Aliases",description:"Restore index aliases from the snapshot",...t.getInputProps("includeAliases",{type:"checkbox"})}),e.jsx(p,{label:"Allow Partial Restore",description:"Allow restore to succeed even if some shards fail",...t.getInputProps("partial",{type:"checkbox"})}),e.jsx(I,{color:"yellow",title:"Warning",children:e.jsx(o,{size:"sm",children:"Restoring a snapshot will close and reopen the target indices. Ensure you understand the implications before proceeding. Use rename pattern to avoid conflicts with existing indices."})}),e.jsxs(j,{justify:"flex-end",mt:"md",children:[e.jsx(d,{variant:"subtle",onClick:i,children:"Cancel"}),e.jsx(d,{type:"submit",loading:c.isPending,color:"orange",children:"Restore Snapshot"})]})]})})})}export{ve as Snapshots};
